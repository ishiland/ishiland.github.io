/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/aspect","dojo/promise/all","dojo/Deferred","dojo/dom-construct","dojo/query","dijit/Menu","dijit/layout/ContentPane","gis/dijit/FloatingTitlePane","gis/dijit/ExpandPane","gis/dijit/FloatingWidgetDialog"],function(e,p,o,t,n,r,s,a,i,d,c,l,h){return e(null,{legendLayerInfos:[],editorLayerInfos:[],identifyLayerInfos:[],layerControlLayerInfos:[],widgets:{},widgetTypes:["contentPane","domNode","expandPane","floating","invisible","layer","layout","loading","map","titlePane","ui"],widgetLayerInfos:["editor","identify","layerControl","legend"],postConfig:function(e){var t=null;if(e)t=new r,e.then(o.hitch(this,function(){n(this.createWidgets(["loading"])).then(t.resolve)}));else{var i=this.createWidgets(["loading"]);i&&i.length&&(t=n(i))}return this.inherited(arguments)||t},startup:function(){this.inherited(arguments),this.widgetTypes=this.widgetTypes.concat(this.config.widgetTypes||[]),this.widgetLayerInfos=this.widgetLayerInfos.concat(this.config.widgetlayerInfos||[]),this.mapDeferred&&this.mapDeferred.then(o.hitch(this,"createWidgets",["map","layer"])),this.layoutDeferred&&(this.layoutDeferred.then(o.hitch(this,"createWidgets",["layout"])),n([this.mapDeferred,this.layoutDeferred]).then(o.hitch(this,"createWidgets",null)))},createWidgets:function(e){var i=[],n=[],a=[],o=[];for(var t in e=e||this.widgetTypes,this.config.widgets)if(this.config.widgets.hasOwnProperty(t)){var r=this.config.widgets[t];r.widgetKey=r.widgetKey||r.id||t,r.include&&!this.widgets[r.widgetKey]&&0<=p.indexOf(e,r.type)&&("titlePane"!==r.type&&"contentPane"!==r.type||r.placeAt||r.uiOptions||(r.placeAt="left"),r.position=this._getPosition(r),i.push(r),this.widgets[t]=!0)}function s(t){return n=p.filter(i,function(e){return!(!e.placeAt||e.placeAt!==t)&&(a.push(e.widgetKey),!0)})}function d(e,t){var i=this.widgetLoader(e,t);i&&o.push(i)}for(var c in this.panes)this.panes.hasOwnProperty(c)&&"outer"!==c&&"center"!==c&&((n=s(c)).sort(function(e,t){return e.position-t.position}),0<n.length&&0!==n[0].position&&(n[0].position=0),p.forEach(n,d,this));return(n=p.filter(i,function(e){return p.indexOf(a,e.widgetKey)<0})).sort(function(e,t){return e.position-t.position}),p.forEach(n,d,this),o},widgetLoader:function(e,t){var i=null,n=this.widgetTypes,a=new r;return p.indexOf(n,e.type)<0?(this.handleError({source:"Controller",error:'Widget type "'+e.type+'" ('+e.title+") at position "+t+" is not supported."}),null):(e.watched=e.watched||"open",this._isPaneWidget(e.type)&&(i=e.parentWidget=this._createParentWidget(e,t)),e.preload=void 0===e.preload||e.preload,e.preload?this._loadWidget(e,a):e.watchHandle=i.watch(e.watched,o.hitch(this,"_loadWidget",e,a)),a)},_loadWidget:function(i,n){"string"==typeof i.options?require([i.options,i.path],o.hitch(this,function(e,t){this.createWidget(i,e,t),n.resolve()})):require([i.path],o.hitch(this,function(e){this.createWidget(i,i.options,e),n.resolve()})),i.watchHandle&&(i.watchHandle.unwatch(),i.watchHandle.remove())},createWidget:function(e,t,i){var n=e.widgetKey;if(n){var a=new i(t=this._setWidgetOptions(e,t),e.srcNodeRef),o=t.parentWidget||{};this._placeWidget(a,o,e),a&&"function"==typeof a.startup&&!a._started&&a.startup(),this.widgets[n]=a,this._hideWidgetLoader(o)}},_setWidgetOptions:function(e,t){return e.id&&(t.id=e.id+"_widget"),t.parentWidget=e.parentWidget,t.map&&(t.map=this.map),t.mapRightClickMenu&&(this.mapRightClickMenu||(this.mapRightClickMenu=new i({targetNodeIds:[this.map.root],selector:".esriMapLayers"}),this.mapRightClickMenu.startup()),t.mapRightClickMenu=this.mapRightClickMenu),t.mapClickMode&&(t.mapClickMode=this.mapClickMode.current),p.forEach(this.widgetLayerInfos,o.hitch(this,function(e){t[e+="LayerInfos"]&&this[e]&&(t.layerInfos=this[e])})),t},_showWidgetLoader:function(e){e&&e.containerNode&&(e.loadingNode=s.create("div",{className:"widgetLoader",innerHTML:'<i class="fas fa-spinner fa-pulse fa-fw"></i>'},e.containerNode,"first"))},_hideWidgetLoader:function(e){e&&e.loadingNode&&require(["dojo/domReady!"],function(){s.destroy(e.loadingNode)})},_createTitlePaneWidget:function(e){var t=o.mixin({open:e.open||!1,canFloat:e.canFloat||!1,resizable:e.resizable||!1,sidebar:this._getPlaceAt(e)},e.paneOptions||{});return"expandPane"===e.type?new l(t):new c(t)},_createFloatingWidget:function(e){return new h(e.paneOptions)},_createContentPaneWidget:function(e){var t=o.mixin({region:e.region||"center"},e.paneOptions||{});return e.className&&(t.className=e.className),new d(t)},_createParentWidget:function(e,t){var i=e.widgetKey+"_parent",n=null;switch(e.position=t,e.srcNodeRef=e.srcNodeRef||s.create("div"),e.paneOptions=o.mixin({id:i,title:e.title,class:i+" "+e.type+"Widget",iconClass:e.iconClass},e.paneOptions||{}),e.type){case"titlePane":case"expandPane":n=this._createTitlePaneWidget(e);break;case"contentPane":n=this._createContentPaneWidget(e),e.preload=!0;break;case"floating":n=this._createFloatingWidget(e)}var a=this._getPlaceAt(e);return a&&"function"==typeof n.placeAt&&n.placeAt(a),"function"!=typeof n.startup||n._started||n.startup(),this._showWidgetLoader(n),e.preload=e.preload||n.get(e.watched)||"function"!=typeof n.watch,n},_isPaneWidget:function(e){return 0<=p.indexOf(["titlePane","contentPane","expandPane","floating"],e)},_placeWidget:function(e,t,i){var n=t.containerNode||this._getPlaceAt(i);return n?"function"==typeof e.placeAt?e.placeAt(n,i.position):s.place(e.domNode,n,i.position):null},_getPlaceAt:function(e){var t=e.placeAt;if("string"==typeof t)if(this.panes[t])t=this.panes[t];else{e.uiOptions&&(t=e.uiOptions.position||t);0<=p.indexOf(["top-left","top-center","top-right","center-left","center-center","center-right","bottom-left","bottom-center","bottom-right","manual"],t)&&(t="manual"===t?".cmv-ui-map .cmv-ui-top-left":".cmv-ui-inset .cmv-ui-"+t);var i=a(t);i&&0<i.length&&(t=i[0])}return t},_getPosition:function(e){var t=e.position;return null==t&&(t=e.uiOptions&&e.uiOptions.index||1e4),t}})});
//# sourceMappingURL=_WidgetsMixin.js.map