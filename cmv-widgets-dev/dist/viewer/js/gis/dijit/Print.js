/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","esri/tasks/PrintTask","dojo/store/Memory","dojo/_base/lang","dojo/_base/array","dojo/topic","dojo/dom-style","dojo/dom-construct","dojo/dom-class","dojo/date/locale","dojo/text!./Print/templates/Print.html","dojo/text!./Print/templates/PrintResult.html","esri/tasks/PrintTemplate","esri/tasks/PrintParameters","esri/request","esri/urlUtils","dojo/i18n!./Print/nls/resource","dijit/form/Form","dijit/form/FilteringSelect","dijit/form/ValidationTextBox","dijit/form/NumberTextBox","dijit/form/Button","dijit/form/CheckBox","dijit/ProgressBar","dijit/form/DropDownButton","dijit/TooltipDialog","dijit/form/RadioButton","xstyle/css!./Print/css/Print.css"],function(declare,_WidgetBase,_TemplatedMixin,_WidgetsInTemplateMixin,PrintTask,Memory,lang,array,topic,Style,domConstruct,domClass,locale,printTemplate,printResultTemplate,PrintTemplate,PrintParameters,esriRequest,urlUtils,i18n){var PrintResultDijit=declare([_WidgetBase,_TemplatedMixin,_WidgetsInTemplateMixin],{widgetsInTemplate:!0,templateString:printResultTemplate,i18n:i18n,url:null,fileHandle:null,resultOrder:"last",postCreate:function(){this.inherited(arguments),this.fileHandle.then(lang.hitch(this,"_onPrintComplete"),lang.hitch(this,"_onPrintError"))},_onPrintComplete:function(t){if(t.url){var e=urlUtils.getProxyRule(t.url);e&&e.proxyUrl?this.url=e.proxyUrl+"?"+t.url:this.url=t.url,this.nameNode.innerHTML='<span class="bold">'+this.docName+"</span>",domClass.add(this.resultNode,"printResultHover")}else this._onPrintError(this.i18n.printResults.errorMessage)},_onPrintError:function(t){topic.publish("viewer/handleError",{source:"Print",error:t}),this.nameNode.innerHTML='<span class="bold">'+i18n.printResults.errorMessage+"</span>",domClass.add(this.resultNode,"printResultError")},_openPrint:function(){null!==this.url&&window.open(this.url)},_handleStatusUpdate:function(t){"esriJobFailed"===t.jobInfo.jobStatus&&this._onPrintError(this.i18n.printResults.errorMessage)}}),PrintDijit=declare([_WidgetBase,_TemplatedMixin,_WidgetsInTemplateMixin],{widgetsInTemplate:!0,templateString:printTemplate,i18n:i18n,map:null,count:1,results:[],authorText:null,copyrightText:null,defaultTitle:null,defaultFormat:null,defaultLayout:null,baseClass:"gis_PrintDijit",pdfIcon:require.toUrl("gis/dijit/Print/images/pdf.png"),imageIcon:require.toUrl("gis/dijit/Print/images/image.png"),printTaskURL:null,printTask:null,postCreate:function(){this.inherited(arguments),this.printparams=new PrintParameters,this.printparams.map=this.map,this.printparams.outSpatialReference=this.map.spatialReference,esriRequest({url:this.printTaskURL,content:{f:"json"},handleAs:"json",callbackParamName:"callback",load:lang.hitch(this,"_handlePrintInfo"),error:lang.hitch(this,"_handleError")})},operationalLayersInspector:function(t){return array.forEach(t,function(t){"Measurement_graphicslayer"===t.id&&array.forEach(t.featureCollection.layers,function(t){array.forEach(t.featureSet.features,function(t){delete t.attributes,t.symbol.font.family="Courier"})})}),t},_handleError:function(t){topic.publish("viewer/handleError",{source:"Print",error:t})},_handlePrintInfo:function(t){this.printTask=new PrintTask(this.printTaskURL,{async:"esriExecutionTypeAsynchronous"===t.executionType});var e=array.filter(t.parameters,function(t){return"Layout_Template"===t.name});if(0!==e.length){var r=array.map(e[0].choiceList,function(t){return{name:t,id:t}});r.sort(function(t,e){return t.name>e.name?1:e.name>t.name?-1:0});var i=new Memory({data:r});this.layoutDijit.set("store",i),this.defaultLayout?this.layoutDijit.set("value",this.defaultLayout):this.layoutDijit.set("value",e[0].defaultValue);var a=array.filter(t.parameters,function(t){return"Format"===t.name});if(0!==a.length){var n=array.map(a[0].choiceList,function(t){return{name:t,id:t}});n.sort(function(t,e){return t.name>e.name?1:e.name>t.name?-1:0});var o=new Memory({data:n});this.formatDijit.set("store",o),this.defaultFormat?this.formatDijit.set("value",this.defaultFormat):this.formatDijit.set("value",a[0].defaultValue)}else topic.publish("viewer/handleError",{source:"Print",error:"Print service parameters name for format must be 'Format'"})}else topic.publish("viewer/handleError",{source:"Print",error:"Print service parameters name for templates must be 'Layout_Template'"})},print:function(){if(this.printSettingsFormDijit.isValid()){var form=this.printSettingsFormDijit.get("value"),preserve=this.preserveFormDijit.get("value");lang.mixin(form,preserve);var layoutForm=this.layoutFormDijit.get("value"),mapQualityForm=this.mapQualityFormDijit.get("value"),mapOnlyForm=this.mapOnlyFormDijit.get("value");lang.mixin(mapOnlyForm,mapQualityForm);var template=new PrintTemplate;template.format=form.format,template.layout=form.layout,template.preserveScale=eval(form.preserveScale),template.outScale=form.outScale,template.label=form.title,template.exportOptions=mapOnlyForm,template.layoutOptions={authorText:this.authorText,copyrightText:this.copyrightText,legendLayers:0<layoutForm.legend.length&&layoutForm.legend[0]?null:[],titleText:form.title,scalebarUnit:layoutForm.scalebarUnit},this.printparams.template=template;var fileHandle=this.printTask.execute(this.printparams),result=new PrintResultDijit({count:this.count.toString(),icon:"PDF"===form.format?this.pdfIcon:this.imageIcon,docName:form.title,title:form.format+", "+form.layout+", "+locale.format(new Date,{formatLength:"short"}),fileHandle:fileHandle}).placeAt(this.printResultsNode,this.resultOrder);this.printTask.async&&result.own(this.printTask.printGp.on("status-update",lang.hitch(result,"_handleStatusUpdate"))),Style.set(this.clearActionBarNode,"display","block"),this.count++}else this.printSettingsFormDijit.validate()},clearResults:function(){domConstruct.empty(this.printResultsNode),Style.set(this.clearActionBarNode,"display","none"),this.count=1}});return PrintDijit});
//# sourceMappingURL=Print.js.map