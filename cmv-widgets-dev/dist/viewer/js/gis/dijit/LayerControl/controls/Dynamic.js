/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/topic","dojo/query","dojo/dom-construct","dojo/dom-attr","dijit/registry","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_Contained","dijit/MenuItem","dijit/MenuSeparator","./_Control","./_DynamicSublayer","./_DynamicFolder","./../plugins/legendUtil","dojo/i18n!./../nls/resource"],function(e,l,a,i,s,t,n,r,h,o,c,d,y,u,f,b,_,p,C){return e([o,c,d,f],{_layerType:"overlay",_esriLayerType:"dynamic",_sublayerControls:[],_folderControls:[],_hasSublayers:!1,_visLayersHandler:null,constructor:function(){this._sublayerControls=[],this._folderControls=[]},_layerTypePreInit:function(){1<this.layer.layerInfos.length&&this.controlOptions.sublayers&&(this._hasSublayers=!0,this._visLayersHandler=i.after(this.layer,"setVisibleLayers",l.hitch(this,"_onSetVisibleLayers"),!0))},_layerTypeInit:function(){var e=p.isLegend(this.controlOptions.noLegend,this.controller.noLegend);e&&!0===this.controlOptions.sublayers?(this._expandClick(),this._createControls(this.layer),i.after(this,"_createControls",l.hitch(this,p.dynamicSublayerLegend(this.layer,this.expandNode)))):!1===this.controlOptions.sublayers&&e?(this._expandClick(),p.layerLegend(this.layer,this.expandNode)):!0!==this.controlOptions.sublayers||e?this._expandRemove():(this._expandClick(),i.after(this,"_createControls",l.hitch(this,"_removeSublayerLegends")),this._createControls(this.layer))},_dynamicToggleMenuItems:function(e){this._hasSublayers&&!1!==this.controlOptions.allSublayerToggles&&(e.addChild(new y({label:C.dynamicSublayersOn,iconClass:"far fa-fw fa-check-square",onClick:l.hitch(this,"_toggleAllSublayers",!0)})),e.addChild(new y({label:C.dynamicSublayersOff,iconClass:"far fa-fw fa-square",onClick:l.hitch(this,"_toggleAllSublayers",!1)})),e.addChild(new u))},_initCustomMenu:function(){this._hasSublayers||(a.forEach(this.controlOptions.subLayerMenu,l.hitch(this,"_addCustomMenuItem",this.layerMenu)),this.layerMenu.addChild(new u))},_toggleAllSublayers:function(i){a.forEach(this._sublayerControls,function(e){e._setSublayerCheckbox(i)}),this._setVisibleLayers()},_createControls:function(e){if(1<e.layerInfos.length){var i=a.map(e.layerInfos,function(e){return e.id});a.forEach(e.layerInfos,l.hitch(this,"_createControl",e,i)),this.controlOptions.ignoreDynamicGroupVisibility&&a.forEach(this._folderControls,function(e){e._checkFolderVisibility()})}},_createControl:function(e,i,s){var t=a.filter(this.controlOptions.subLayerInfos,function(e){return e.id===s.id}).shift();l.mixin(s,t);var r=s.parentLayerId,o=s.subLayerIds;-1===r||-1===i.indexOf(r)?null===o?this._createDynamicSubLayer(s,e):null!==o&&this._createDynamicFolder(s,e):-1!==r&&null!==o?this._createDynamicFolder(s,e):-1!==r&&null===o&&this._createDynamicSubLayer(s,e)},_createDynamicSubLayer:function(e,i){var s=i.id+"-"+e.id+"-sublayer-control",t=e.parentLayerId,r=null,o=new b({id:s,control:this,sublayerInfo:e,icons:this.icons});(r=-1===t?this.expandNode:h.byId(i.id+"-"+t+"-sublayer-control").expandNode)&&(n.place(o.domNode,r,"last"),o.startup(),this._sublayerControls.push(o))},_createDynamicFolder:function(e,i){var s=i.id+"-"+e.id+"-sublayer-control",t=e.parentLayerId,r=null,o=new _({id:s,control:this,sublayerInfo:e,icons:this.icons});(r=-1===t?this.expandNode:h.byId(i.id+"-"+t+"-sublayer-control").expandNode)&&(n.place(o.domNode,r,"last"),o.startup(),this._folderControls.push(o))},_removeSublayerLegends:function(){a.forEach(this._sublayerControls,function(e){e.sublayerInfo.subLayerIds||n.destroy(e.expandClickNode)})},_setVisibleLayers:function(){this._visLayersHandler.remove();var e=this.layer,r=[],o=[],n=this.controlOptions.ignoreDynamicGroupVisibility;a.forEach(this._sublayerControls,function(e){e._isVisible()&&-1===e.parentLayerId&&(r.push(e.sublayerInfo.id),o.push(e.sublayerInfo.id))}),a.forEach(this._folderControls,l.hitch(this,function(e){(e._isVisible()||n&&e._hasAnyVisibleLayer())&&o.push(e.sublayerInfo.id)})),a.forEach(this._folderControls,l.hitch(this,function(e){var i=e._getSubLayerControls();a.forEach(i,l.hitch(this,function(e){if(e._isVisible()&&(o.push(e.sublayerInfo.id),n))r.push(e.sublayerInfo.id);else{for(var i=e,s=null;i._isVisible()&&-1!==i.sublayerInfo.parentLayerId&&s!==i;)s=i,a.forEach(this._folderControls,t);i._isVisible()&&r.push(e.sublayerInfo.id)}function t(e){e.sublayerInfo.id===i.sublayerInfo.parentLayerId&&(i=e)}}))})),r.length||r.push(-1),n&&a.forEach(this._folderControls,function(e){e._checkFolderVisibility()}),e.setVisibleLayers(r),e.refresh(),s.publish("layerControl/setVisibleLayers",{id:e.id,visibleLayers:r}),s.publish("layerControl/setAllVisibleLayers",{id:e.id,allVisibleLayers:o}),this._visLayersHandler=i.after(this.layer,"setVisibleLayers",l.hitch(this,"_onSetVisibleLayers"),!0)},_onSetVisibleLayers:function(s,t){a.forEach(this._sublayerControls,function(e){var i=-1!==a.indexOf(s,e.sublayerInfo.id);e._setSublayerCheckbox(i,null,t)}),a.forEach(this._folderControls,function(e){var i=-1!==a.indexOf(s,e.sublayerInfo.id);e._setFolderCheckbox(i,null,t)}),this.controlOptions.ignoreDynamicGroupVisibility&&a.forEach(this._folderControls,function(e){e._checkFolderVisibility()})}})});
//# sourceMappingURL=Dynamic.js.map