/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/on","dojo/topic","dojo/dom-construct","dojo/dom-style","dojo/dom-class","dojo/dom-attr","dojo/fx","dojo/html","dijit/MenuItem","./../plugins/LayerMenu","dojo/text!./templates/Control.html"],function(e,n,i,a,o,t,l,s,h,c,r,d,u,p){return e([],{templateString:p,controller:null,layer:null,layerTitle:"Layer Title",controlOptions:null,layerMenu:null,icons:null,_reorderUp:null,_reorderDown:null,_scaleRangeHandler:null,_expandClickHandler:null,constructor:function(e){e.controller&&(this.icons=n.clone(e.controller.icons)),this._handlers=[]},postCreate:function(){return this.inherited(arguments),this.controller?this.layer?void(this.layer.loaded?this._initialize():this._handlers.push(this.layer.on("load",n.hitch(this,"_initialize")))):(o.publish("viewer/handleError",{source:"LayerControl/_Control",error:"layer option is required"}),void this.destroy()):(o.publish("viewer/handleError",{source:"LayerControl/_Control",error:"controller option is required"}),void this.destroy())},_initialize:function(){this._layerTypePreInit&&this._layerTypePreInit();var e=this.layer,t=this.controlOptions;this._setLayerCheckbox(e,this.checkNode),r.set(this.labelNode,this.layerTitle),!0!==t.noMenu&&!0!==this.controller.noMenu||!0===this.controller.noMenu&&!1===t.noMenu?(this.layerMenu=new u({control:this,contextMenuForWindow:!1,targetNodeIds:[this.menuNode],leftClickToOpen:!0}),this.layerMenu.startup(),this._initCustomMenu()):(s.remove(this.menuNode,"fa, layerControlMenuIcon, "+this.icons.menu),l.set(this.menuClickNode,"cursor","default")),0===e.minScale&&0===e.maxScale||(this._checkboxScaleRange(),this._scaleRangeHandler=e.getMap().on("zoom-end",n.hitch(this,"_checkboxScaleRange"))),this._layerTypeInit(),t.expanded&&t.sublayers&&this.expandClickNode.click(),this._handlers.push(a(this.checkNode,"click",n.hitch(this,"_setLayerVisibility",e,this.checkNode)),e.on("scale-range-change",n.hitch(this,"_scaleRangeChange")),e.on("update-start",n.hitch(this,"_updateStart")),e.on("update-end",n.hitch(this,"_updateEnd")),e.on("visibility-change",n.hitch(this,"_visibilityChange")))},_initCustomMenu:function(){i.forEach(this.controlOptions.menu,n.hitch(this,"_addCustomMenuItem",this.layerMenu))},_addCustomMenuItem:function(e,t){var i=new d(t);i.set("onClick",n.hitch(this,function(){o.publish("layerControl/"+t.topic,{layer:this.layer,iconNode:this.iconNode,menuItem:i})})),e.addChild(i)},_expandClick:function(){this._expandClickHandler=a(this.expandClickNode,"click",n.hitch(this,"_expandClicked")),this._handlers.push(this._expandClickHandler)},_expandClicked:function(){var e=this.icons,t=this.expandNode,i=this.expandIconNode;"none"===l.get(t,"display")?(c.wipeIn({node:t,duration:300}).play(),s.replace(i,e.collapse,e.expand)):(c.wipeOut({node:t,duration:300}).play(),s.replace(i,e.expand,e.collapse))},_expandRemove:function(){s.remove(this.expandIconNode,["fa",this.icons.expand,"layerControlToggleIcon"]),l.set(this.expandClickNode,"cursor","default"),t.destroy(this.expandNode)},_setLayerVisibility:function(e,t,i){i.stopPropagation&&i.stopPropagation(),e.visible?(this._setLayerCheckbox(e,t),e.hide()):(this._setLayerCheckbox(e,t),e.show()),o.publish("layerControl/layerToggle",{id:e.id,visible:e.visible,params:e._params}),0===e.minScale&&0===e.maxScale||this._checkboxScaleRange()},_setLayerCheckbox:function(e,t){var i=this.icons;e.visible?(h.set(t,"data-checked","checked"),s.replace(t,i.checked,i.unchecked)):(h.set(t,"data-checked","unchecked"),s.replace(t,i.unchecked,i.checked))},_checkboxScaleRange:function(){var e=this.checkNode,t=this.layer,i=t.getMap().getScale(),n=t.minScale,a=t.maxScale;s.remove(e,"layerControlCheckIconOutScale"),(0!==n&&n<i||0!==a&&i<a)&&s.add(e,"layerControlCheckIconOutScale")},_scaleRangeChange:function(){if(0!==this.layer.minScale||0!==this.layer.maxScale){if(this._checkboxScaleRange(),this._scaleRangeHandler){var e=i.indexOf(this._handlers,this._scaleRangeHandler);-1!==e&&(this._handlers[e].remove(),this._handlers.splice(e,1))}this._scaleRangeHandler=this.layer.getMap().on("zoom-end",n.hitch(this,"_checkboxScaleRange")),this._handlers.push(this._scaleRangeHandler)}else if(this._checkboxScaleRange(),this._scaleRangeHandler){var t=i.indexOf(this._handlers,this._scaleRangeHandler);-1!==t&&(this._handlers[t].remove(),this._handlers.splice(t,1)),this._scaleRangeHandler=null}},_updateStart:function(){l.set(this.layerUpdateNode,"display","inline-block"),this._layerState=n.clone({visible:this.layer.visible,visibleLayers:this.layer.visibleLayers||null})},_updateEnd:function(){l.set(this.layerUpdateNode,"display","none"),this._layerState||(this._layerState=null)},_visibilityChange:function(e){(e.visible&&"unchecked"===h.get(this.checkNode,"data-checked")||!e.visible&&"checked"===h.get(this.checkNode,"data-checked"))&&this._setLayerCheckbox(this.layer,this.checkNode)},destroy:function(){this.inherited(arguments),this._handlers.forEach(function(e){e.remove()})}})});
//# sourceMappingURL=_Control.js.map