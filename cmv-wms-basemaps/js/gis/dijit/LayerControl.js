/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/topic","dojo/dom-attr","dojo/dom-construct","dijit/_WidgetBase","dijit/_Container","dijit/layout/ContentPane","dijit/form/Button","esri/tasks/ProjectParameters","esri/config","require","xstyle/css!./LayerControl/css/LayerControl.css"],function(e,r,o,t,i,n,a,s,l,d,c,h,y){return e([a,s],{map:null,layerInfos:[],icons:{expand:"fa-caret-right fa-fw layerControlIcon-Expand",collapse:"fa-caret-down fa-fw layerControlIcon-Collapse",checked:"fa-check fa-fw fa-border layerControlIcon-Checked",unchecked:"fa-square fa-fw fa-border layerControlIcon-Unchecked",indeterminate:"fa-minus fa-fw fa-border layerControlIcon-Indeterminate",update:"fa-refresh layerControlIcon-Update",menu:"fa-bars layerControlIcon-Menu",folder:"fa-folder-o fa-fw layerControlIcon-Folder",folderOpen:"fa-folder-open-o fa-fw layerControlIcon-Folder layerControlIcon-FolderOpen"},separated:!1,overlayReorder:!1,overlayLabel:!1,vectorReorder:!1,vectorLabel:!1,noMenu:null,noLegend:null,noZoom:null,noTransparency:null,menu:{},subLayerMenu:{},swipe:null,swiperButtonStyle:"position:absolute;top:20px;left:120px;z-index:50;",baseClass:"layerControlDijit",_vectorContainer:null,_overlayContainer:null,_swiper:null,_swipeLayerToggleHandle:null,_groupedLayerInfos:{},_controls:{dynamic:"./LayerControl/controls/Dynamic",feature:"./LayerControl/controls/Feature",image:"./LayerControl/controls/Image",tiled:"./LayerControl/controls/Tiled",csv:"./LayerControl/controls/CSV",georss:"./LayerControl/controls/GeoRSS",wms:"./LayerControl/controls/WMS",wfs:"./LayerControl/controls/WFS",kml:"./LayerControl/controls/KML",vectortile:"./LayerControl/controls/VectorTile",webtiled:"./LayerControl/controls/WebTiled",imagevector:"./LayerControl/controls/ImageVector",raster:"./LayerControl/controls/Raster",stream:"./LayerControl/controls/Stream",grouped:"./LayerControl/controls/Grouped",graphics:"./LayerControl/controls/Graphics",osm:"./LayerControl/controls/OpenStreetMap"},constructor:function(e){(e=e||{}).map?this._controls=o.mixin(this._controls,e.controls||{}):t.publish("viewer/handleError",{source:"LayerControl",error:"map option is required"})},postCreate:function(){if(this.inherited(arguments),this.separated){var r=e([a,s]);!1!==this.vectorLabel&&this.addChild(new l({className:"vectorLabelContainer",content:this.vectorLabel},n.create("div")),"first"),this._vectorContainer=new r({className:"vectorLayerContainer"},n.create("div")),this.addChild(this._vectorContainer,"last"),!1!==this.overlayLabel&&this.addChild(new l({className:"overlayLabelContainer",content:this.overlayLabel},n.create("div")),"last"),this._overlayContainer=new r({className:"overlayLayerContainer"},n.create("div")),this.addChild(this._overlayContainer,"last")}else this.overlayReorder=!1,this.vectorReorder=!1;this._addLayerControls(this.layerInfos),this._subscribeToTopics()},_subscribeToTopics:function(){this._removeLayerControlsHandler=t.subscribe("layerControl/removeLayerControls",o.hitch(this,function(e){this._removeLayerControls(e)})),this._addLayerControlsHandler=t.subscribe("layerControl/addLayerControls",o.hitch(this,function(e){this._addLayerControls(e)}))},_addLayerControls:function(e){var i=[];r.forEach(e,function(e){e.controlOptions=e.controlOptions||{};var r=e.controlOptions;if(!0!==r.exclude){r.layerGroup&&(this.overlayReorder=!1,this.vectorReorder=!1);var o=this._controls[e.type];o?i.push(o):t.publish("viewer/handleError",{source:"LayerControl",error:'the layer type "'+e.type+'" is not supported'})}},this),y(i,o.hitch(this,function(){r.forEach(e,function(e){if(!0!==e.controlOptions.exclude){var r=this._controls[e.type];r&&y([r],o.hitch(this,"_addControl",e))}},this);for(var t in this._groupedLayerInfos)if(this._groupedLayerInfos.hasOwnProperty(t)){var i=this._groupedLayerInfos[t];if(i&&i.length>1){var n=this._controls.grouped,a={title:t,type:"grouped",controlOptions:{},layer:{id:t.replace(/\s/g,""),loaded:!0,getMap:o.hitch(this,function(){return this.map}),minScale:0,maxScale:0,_params:{}},layerDetails:i};y([n],o.hitch(this,"_addControl",a))}}this._checkReorder()}))},_removeLayerControls:function(e){function t(r){return e.reduce(function(e,o){return o===r.layer||e},!1)}var i=this._overlayContainer.getChildren().filter(function(e){return t(e)}).concat(this._vectorContainer.getChildren().filter(function(e){return t(e)})).concat(this.getChildren().filter(function(e){return t(e)}));r.forEach(i,o.hitch(this,function(e){this.separated?"overlay"===e._layerType?this._overlayContainer.removeChild(e):this._vectorContainer.removeChild(e):this.removeChild(e),e.destroy()}))},_addControl:function(e,r){var t="string"==typeof e.layer?this.map.getLayer(e.layer):e.layer;"dynamic"!==e.type&&"feature"!==e.type||(t.loaded?this._applyLayerControlOptions(e.controlOptions,t):t.on("load",o.hitch(this,"_applyLayerControlOptions",e.controlOptions)));var i=new r({controller:this,layer:t,layerTitle:e.title,layerDetails:e.layerDetails,controlOptions:o.mixin({noLegend:null,noZoom:null,noTransparency:null,swipe:null,expanded:!1,sublayers:!0,layerGroup:null,menu:this.menu[e.type],subLayerMenu:this.subLayerMenu[e.type]},e.controlOptions)});i.startup();var n=e.position||0,a=i._layerType;"grouped"===a&&i.layerDetails&&i.layerDetails.length>0&&(i._layerType=i.layerDetails[0].layerControl._layerType),this.separated?"overlay"===a?this._overlayContainer.addChild(i,n):this._vectorContainer.addChild(i,n):this.addChild(i,n),this._storeGroupedLayerInfo(e,i)},_storeGroupedLayerInfo:function(e,r){if(e.controlOptions.layerGroup){var o=e.controlOptions.layerGroup;this._groupedLayerInfos.hasOwnProperty(o)||(this._groupedLayerInfos[o]=[]),this._groupedLayerInfos[o].push({layerInfo:e,layerControl:r})}},_applyLayerControlOptions:function(e,o){if(void 0!==e.includeUnspecifiedLayers||void 0!==e.subLayerInfos||void 0!==e.excludedLayers){var t=[];if(!e.includeUnspecifiedLayers&&e.subLayerInfos&&0!==e.subLayerInfos.length){var i=r.map(e.subLayerInfos,function(e){return e.id});r.forEach(o.layerInfos,function(e){-1!==r.indexOf(i,e.id)&&t.push(e)})}else if(e.excludedLayers)r.forEach(o.layerInfos,function(o){-1===r.indexOf(e.excludedLayers,o.id)&&t.push(o)});else if(e.subLayerInfos)return this._mixinLayerInfos(o.layerInfos,e.subLayerInfos),void this._setSublayerVisibilities(o);e.subLayerInfos&&this._mixinLayerInfos(t,e.subLayerInfos),o.layerInfos=t,this._setSublayerVisibilities(o)}},_setSublayerVisibilities:function(e){var o=r.map(r.filter(e.layerInfos,function(e){return e.defaultVisibility}),function(e){return e.id});e.setVisibleLayers(o)},_mixinLayerInfos:function(e,t){t&&0!==t.length&&(r.forEach(t,function(e){void 0===e.defaultVisibility&&(e.defaultVisibility=!0)}),r.forEach(e,function(e){var i=r.filter(t,function(r){return r.id===e.id}).shift();i&&o.mixin(e,i)}))},_moveUp:function(e){var o,t=e.layer.id,i=e.domNode;"overlay"===e._layerType?e.getPreviousSibling()&&(o=r.indexOf(this.map.layerIds,t),this.map.reorderLayer(t,o+1),this._overlayContainer.containerNode.insertBefore(i,i.previousSibling),this._checkReorder()):"vector"===e._layerType&&e.getPreviousSibling()&&(o=r.indexOf(this.map.graphicsLayerIds,t),this.map.reorderLayer(t,o+1),this._vectorContainer.containerNode.insertBefore(i,i.previousSibling),this._checkReorder())},_moveDown:function(e){var o,t=e.layer.id,i=e.domNode;"overlay"===e._layerType?e.getNextSibling()&&(o=r.indexOf(this.map.layerIds,t),this.map.reorderLayer(t,o-1),this._overlayContainer.containerNode.insertBefore(i,i.nextSibling.nextSibling),this._checkReorder()):"vector"===e._layerType&&e.getNextSibling()&&(o=r.indexOf(this.map.graphicsLayerIds,t),this.map.reorderLayer(t,o-1),this._vectorContainer.containerNode.insertBefore(i,i.nextSibling.nextSibling),this._checkReorder())},_checkReorder:function(){this.separated&&(this.vectorReorder&&r.forEach(this._vectorContainer.getChildren(),function(e){e._reorderUp&&(e.getPreviousSibling()?e._reorderUp.set("disabled",!1):e._reorderUp.set("disabled",!0)),e._reorderDown&&(e.getNextSibling()?e._reorderDown.set("disabled",!1):e._reorderDown.set("disabled",!0))},this),this.overlayReorder&&r.forEach(this._overlayContainer.getChildren(),function(e){e._reorderUp&&(e.getPreviousSibling()?e._reorderUp.set("disabled",!1):e._reorderUp.set("disabled",!0)),e._reorderDown&&(e.getNextSibling()?e._reorderDown.set("disabled",!1):e._reorderDown.set("disabled",!0))},this))},_zoomToLayer:function(e){if("esri.layers.KMLLayer"!==e.declaredClass){var r=this.map;e.spatialReference===r.spatialReference?r.setExtent(e.fullExtent,!0):h.defaults.geometryService?h.defaults.geometryService.project(o.mixin(new c,{geometries:[e.fullExtent],outSR:r.spatialReference}),function(e){r.setExtent(e[0],!0)},function(e){t.publish("viewer/handleError",{source:"LayerControl._zoomToLayer",error:e})}):t.publish("viewer/handleError",{source:"LayerControl._zoomToLayer",error:"esriConfig.defaults.geometryService is not set"})}},_swipeLayer:function(e,r){e&&e.visible&&(this._swiper?(this._swiper.disable(),this._swipeLayerToggleHandle&&this._swipeLayerToggleHandle.remove(),this._swiper.set("layers",[e]),this._swiper.set("type",r),this._swiper.enable(),i.set(this._swiper.disableBtn.domNode,"style",this.swiperButtonStyle)):y(["esri/dijit/LayerSwipe"],o.hitch(this,function(t){this._swiper=new t({type:r||"vertical",map:this.map,layers:[e]},n.create("div",{},this.map.id,"first")),this._swiper.startup(),this._swiper.disableBtn=new d({label:"Exit Layer Swipe",onClick:o.hitch(this,"_swipeDisable")},n.create("div",{},this.map.id)),i.set(this._swiper.disableBtn.domNode,"style",this.swiperButtonStyle)})),this._swipeLayerToggleHandle=t.subscribe("layerControl/layerToggle",o.hitch(this,function(r){r.id!==e.id||r.visible||this._swipeDisable()})))},_swipeDisable:function(){this._swiper.disable(),this._swipeLayerToggleHandle&&this._swipeLayerToggleHandle.remove(),i.set(this._swiper.disableBtn.domNode,"style","display:none;")},showAllLayers:function(){this.separated?(r.forEach(this._vectorContainer.getChildren(),function(e){e.layer.show()}),r.forEach(this._overlayContainer.getChildren(),function(e){e.layer.show()})):r.forEach(this.getChildren(),function(e){e.layer.show()})},hideAllLayers:function(){this.separated?(r.forEach(this._vectorContainer.getChildren(),function(e){e.layer.hide()}),r.forEach(this._overlayContainer.getChildren(),function(e){e.layer.hide()})):r.forEach(this.getChildren(),function(e){e.layer.hide()})}})});
//# sourceMappingURL=LayerControl.js.map