/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/topic","dojo/query","dojo/dom-construct","dojo/dom-attr","dijit/registry","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_Contained","dijit/MenuItem","dijit/MenuSeparator","./_Control","./_DynamicSublayer","./_DynamicFolder","./../plugins/legendUtil","dojo/i18n!./../nls/resource"],function(e,s,i,t,n,a,r,o,l,d,y,h,c,u,b,f,_,p,L){return e([d,y,h,b],{_layerType:"overlay",_esriLayerType:"dynamic",_hasSublayers:!1,_visLayersHandler:null,constructor:function(){this._sublayerControls=[]},_layerTypePreInit:function(){this.layer.layerInfos.length>1&&this.controlOptions.sublayers&&(this._hasSublayers=!0,this._visLayersHandler=t.after(this.layer,"setVisibleLayers",s.hitch(this,"_onSetVisibleLayers"),!0))},_layerTypeInit:function(){var e=p.isLegend(this.controlOptions.noLegend,this.controller.noLegend);e&&!0===this.controlOptions.sublayers?(this._expandClick(),this._createSublayers(this.layer),t.after(this,"_createSublayers",s.hitch(this,p.dynamicSublayerLegend(this.layer,this.expandNode)))):!1===this.controlOptions.sublayers&&e?(this._expandClick(),p.layerLegend(this.layer,this.expandNode)):!0!==this.controlOptions.sublayers||e?this._expandRemove():(this._expandClick(),t.after(this,"_createSublayers",s.hitch(this,"_removeSublayerLegends")),this._createSublayers(this.layer))},_dynamicToggleMenuItems:function(e){this._hasSublayers&&!1!==this.controlOptions.allSublayerToggles&&(e.addChild(new c({label:L.dynamicSublayersOn,onClick:s.hitch(this,"_toggleAllSublayers",!0)})),e.addChild(new c({label:L.dynamicSublayersOff,onClick:s.hitch(this,"_toggleAllSublayers",!1)})),e.addChild(new u))},_initCustomMenu:function(){this._hasSublayers||(i.forEach(this.controlOptions.subLayerMenu,s.hitch(this,"_addCustomMenuItem",this.layerMenu)),this.layerMenu.addChild(new u))},_toggleAllSublayers:function(e){i.forEach(this._sublayerControls,function(s){s._setSublayerCheckbox(e)}),this._setVisibleLayers()},_createSublayers:function(e){if(e.layerInfos.length>1){var t=i.map(e.layerInfos,function(e){return e.id});i.forEach(e.layerInfos,s.hitch(this,function(n){var a=i.filter(this.controlOptions.subLayerInfos,function(e){return e.id===n.id}).shift();s.mixin(n,a);var o,d=n.parentLayerId,y=n.subLayerIds,h=e.id+"-"+n.id+"-sublayer-control";-1===d||-1===t.indexOf(d)?null===y?(o=new f({id:h,control:this,sublayerInfo:n,icons:this.icons}),r.place(o.domNode,this.expandNode,"last")):null!==y&&(o=new _({id:h,control:this,sublayerInfo:n,icons:this.icons}),r.place(o.domNode,this.expandNode,"last")):-1!==d&&null!==y?(o=new _({id:h,control:this,sublayerInfo:n,icons:this.icons}),r.place(o.domNode,l.byId(e.id+"-"+n.parentLayerId+"-sublayer-control").expandNode,"last")):-1!==d&&null===y&&(o=new f({id:h,control:this,sublayerInfo:n,icons:this.icons}),r.place(o.domNode,l.byId(e.id+"-"+n.parentLayerId+"-sublayer-control").expandNode,"last")),o.startup(),this._sublayerControls.push(o)}))}},_removeSublayerLegends:function(){i.forEach(this._sublayerControls,function(e){e.sublayerInfo.subLayerIds||r.destroy(e.expandClickNode)})},_setVisibleLayers:function(){this._visLayersHandler.remove();var e=this.layer,r=[];i.forEach(a("."+e.id+"-layerControlSublayerCheck"),function(e){"checked"===o.get(e,"data-checked")&&r.push(parseInt(o.get(e,"data-sublayer-id"),10))}),i.forEach(e.layerInfos,function(e){null!==e.subLayerIds&&-1===i.indexOf(r,e.id)?i.forEach(e.subLayerIds,function(e){-1!==i.indexOf(r,e)&&r.splice(i.indexOf(r,e),1)}):null!==e.subLayerIds&&-1!==i.indexOf(r,e.id)&&r.splice(i.indexOf(r,e.id),1)}),r.length||r.push(-1),e.setVisibleLayers(r),e.refresh(),n.publish("layerControl/setVisibleLayers",{id:e.id,visibleLayers:r}),this._visLayersHandler=t.after(this.layer,"setVisibleLayers",s.hitch(this,"_onSetVisibleLayers"),!0)},_onSetVisibleLayers:function(e){var s=[];i.forEach(this.layer.layerInfos,function(t){-1!==i.indexOf(e,t.id)&&s.push(t.id),-1!==t.parentLayerId&&-1===i.indexOf(s,t.parentLayerId)&&s.push(t.parentLayerId)}),i.forEach(this._sublayerControls,function(e){-1!==i.indexOf(s,e.sublayerInfo.id)?e._setSublayerCheckbox(!0):e._setSublayerCheckbox(!1)})}})});
//# sourceMappingURL=Dynamic.js.map