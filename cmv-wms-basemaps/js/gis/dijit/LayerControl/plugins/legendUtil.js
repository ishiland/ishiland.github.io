/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/array","dojo/_base/lang","dojo/has","dojo/topic","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/html","dijit/registry","dojox/gfx","esri/request","esri/dijit/Legend","dojo/i18n!esri/nls/jsapi","dojo/i18n!./../nls/resource"],function(e,r,a,t,n,i,o,s,l,c,d,g,y,u){return y.widgets.legend.NLS_noLegend=u.noLegend,{isLegend:function(e,r){return null===r||!1===r?!0!==e:!0===r&&!1===e},_legendRequest:function(e,a,t,n){var i={f:"json",token:"function"==typeof e._getToken?e._getToken():null},o={disableIdentityLookup:!1,usePost:!1,useProxy:!1};e.layerDrawingOptions&&e.layerDrawingOptions.length>0&&(i.dynamicLayers=this._createDynamicLayerParameter(e),o.usePost=!0),d({url:e.url+"/legend",callbackParamName:"callback",content:i},o).then(r.hitch(this,t,e,a),r.hitch(this,n,e,a))},_arcgisLegendRequest:function(e,t,n,i){var o=e.url.toLowerCase().indexOf("/rest/"),s=e.url.substring(0,o)+e.url.substring(o+5,e.url.length),l="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+window.escape(s);(!a("ie")||a("ie")>8)&&(l+="&returnbytes=true"),d({url:l,callbackParamName:"callback",content:{f:"json"}}).then(r.hitch(this,n,e,t),r.hitch(this,i,e,t))},_image:function(e,r,t){var i=e.url;if((!a("ie")||a("ie")>=9)&&e.imageData&&e.imageData.length>0)i="data:image/png;base64,"+e.imageData;else if(0!==e.url.indexOf("http")){i=t.url+"/"+r+"/images/"+e.url;var s=t._getToken();s&&(i+="?token="+s)}var l=n.create("img",{src:i,class:t.id+"-layerLegendImage"});return o.set(l,{width:e.width+"px",height:e.height+"px",opacity:t.opacity}),l},layerLegend:function(e,r){var a=new g({map:e.getMap(),layerInfos:[{layer:e}]},n.create("div",{},r));setTimeout(function(){a.startup()},1)},dynamicSublayerLegend:function(e,r){e.version>=10.01?this._legendRequest(e,r,"_createDynamicSublayerLegend","_dynamicSublayerLegendError"):this._arcgisLegendRequest(e,r,"_createDynamicSublayerLegend","_dynamicSublayerLegendError")},_createDynamicSublayerLegend:function(r,a,t){e.forEach(t.layers,function(t){var o=t.layerId,c=n.create("table");if(i.add(c,"layerControlLegendTable"),e.forEach(t.legend,function(e){var a=n.create("tr",{},c,"last"),t=n.create("td",{class:"layerControlLegendImage"},a,"first");n.create("td",{innerHTML:e.label||"&nbsp;",class:"layerControlLegendLabel"},a,"last"),n.place(this._image(e,o,r),t)},this),r.layerInfos.reduce(function(e,r){return r.id===t.layerId||e},!1))if(r.layerInfos.length>1){var d=l.byId(r.id+"-"+t.layerId+"-sublayer-control").expandNode;s.set(d,""),n.place(c,d)}else n.place(c,a)},this)},_dynamicSublayerLegendError:function(e,r,a){1===e.layerInfos.length&&s.set(r,"No Legend"),t.publish("viewer/handleError",{source:"LayerControl/legendUtil/_createDynamicSublayerLegend",error:a})},_surfaceDims:[20,20],vectorLegend:function(e,r){var a=e.renderer.symbol,t=e.renderer.infos;a?this._createVectorLegend([{symbol:a,description:"",label:"",value:""}],e,r):t?this._createVectorLegend(t,e,r):s.set(r,"No Legend")},_createVectorLegend:function(r,a,l){var d=n.create("table");i.add(d,"layerControlLegendTable"),e.forEach(r,function(e){var r=n.create("tr",{},d,"last"),g=n.create("td",{class:"layerControlLegendImage"},r,"first");n.create("td",{innerHTML:e.label||"&nbsp;",class:"layerControlLegendLabel"},r,"last");var y=e.symbol,u=y.getShapeDescriptors(),h=u.defaultShape,f=u.fill,m=u.stroke;if(h.src){var L=n.create("img",{src:h.src},g);o.set(L,{width:y.width+"px",height:y.height+"px",opacity:a.opacity}),i.add(L,a.id+"-layerLegendImage")}else if(y){var p=this._surfaceDims[0],b=this._surfaceDims[1];y.width&&y.height&&(p=y.width,b=y.height);var _=n.create("span",{},g);o.set(_,{width:p+"px",height:b+"px",display:"inline-block"});var v=c.createSurface(_,p,b).createShape(h);f&&v.setFill(f),m&&v.setStroke(m),v.applyTransform({dx:p/2,dy:b/2}),o.set(g,{opacity:a.opacity}),i.add(g,a.id+"-layerLegendImage")}else s.set(l,"No Legend"),t.publish("viewer/handleError",{source:"LayerControl/legendUtil/_createVectorLegend",error:"renderer does not contain symbol(s)"});n.place(d,l)},this)},_createDynamicLayerParameter:function(e){if(e.dynamicLayerInfos&&e.dynamicLayerInfos.length>0||e.layerDrawingOptions&&e.layerDrawingOptions.length>0){e.dynamicLayerInfos=e.createDynamicLayerInfosFromLayerInfos();var r=[];return e.dynamicLayerInfos.forEach(function(a){if(!a.subLayerIds){var t,n=a.id;t={id:n,name:a.name},a.source&&(t.source=a.source.toJson()),e.layerDrawingOptions&&e.layerDrawingOptions[n]&&(t.drawingInfo=e.layerDrawingOptions[n].toJson()),r.push(t)}},this),JSON.stringify(r)}return null}}});
//# sourceMappingURL=legendUtil.js.map