/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/MenuItem","dojo/_base/lang","dojo/_base/array","dojo/promise/all","dojo/topic","dojo/query","dojo/dom-style","dojo/dom-class","dojo/dnd/Moveable","dojo/store/Memory","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/dijit/PopupTemplate","esri/layers/FeatureLayer","esri/TimeExtent","dojo/Deferred","dojo/text!./Identify/templates/Identify.html","dojo/i18n!./Identify/nls/resource","./Identify/Formatters","dijit/form/Form","dijit/form/FilteringSelect","xstyle/css!./Identify/css/Identify.css"],function(e,i,t,a,r,n,s,l,o,f,d,h,c,u,y,p,m,I,g,v,L,b,T){return e([i,t,a],{widgetsInTemplate:!0,templateString:L,baseClass:"gis_IdentifyDijit",i18n:b,mapClickMode:null,identifies:{},infoTemplates:{},featureLayers:{},ignoreOtherGraphics:!0,createDefaultInfoTemplates:!0,draggable:!1,layerSeparator:"||",allLayersId:"***",excludedFields:["objectid","esri_oid","shape","shape.len","shape_length","shape_len","shape.stlength()","shape.area","shape_area","shape.starea()"],defaultFormatters:{esriFieldTypeSmallInteger:T.formatInt,esriFieldTypeInteger:T.formatInt,esriFieldTypeSingle:T.formatFloat,esriFieldTypeDouble:T.formatFloat,esriFieldTypeDate:T.formatDate},postCreate:function(){this.inherited(arguments),this.identifies||(this.identifies={}),this.layers=[],this.addLayerInfos(this.layerInfos),this.own(o.subscribe("mapClickMode/currentSet",n.hitch(this,"setMapClickMode"))),this.own(o.subscribe("identify/addLayerInfos",n.hitch(this,"addLayerInfos"))),this.map.on("click",n.hitch(this,function(e){"identify"===this.mapClickMode&&this.executeIdentifyTask(e)})),this.mapRightClickMenu&&this.addRightClickMenu(),this.parentWidget&&(this.createIdentifyLayerList(),this.map.on("update-end",n.hitch(this,function(){this.createIdentifyLayerList()}))),this.draggable&&this.setupDraggable()},addLayerInfos:function(e){s.forEach(e,n.hitch(this,"addLayerInfo"))},addLayerInfo:function(e){var i,t=e.layer.id,a=this.map.getLayer(t);if(a){var r=a.url;if("esri.layers.FeatureLayer"===a.declaredClass){if(a.capabilities&&s.indexOf(a.capabilities.toLowerCase(),"data")<0&&!a.infoTemplate&&(i=this.getInfoTemplate(a,a.layerId))){a.setInfoTemplate(i);var l=i.info.fieldInfos;s.filter(l,function(e){return e.formatter}).length>0&&a.on("graphic-draw",n.hitch(this,"getFormattedFeature",a.infoTemplate))}var o=r.lastIndexOf("/"+a.layerId);o>0&&(r=r.substring(0,o))}else a.layerInfos&&s.forEach(a.layerInfos,n.hitch(this,function(i){var t=i.id;(null===e.layerIds||s.indexOf(e.layerIds,t)>=0)&&this.getFeatureLayerForDynamicSublayer(a,t)}));this.layers.push({ref:a,layerInfo:e,identifyTask:new y(r)}),this.parentWidget&&a.on("visibility-change",n.hitch(this,function(e){!1===e.visible&&this.createIdentifyLayerList()}))}},addRightClickMenu:function(){this.map.on("MouseDown",n.hitch(this,function(e){this.mapRightClick=e})),this.mapRightClickMenu.addChild(new r({label:this.i18n.rightClickMenuItem.label,onClick:n.hitch(this,"handleRightClick")}))},setupDraggable:function(){var e,i,t,a;e=f("div.esriPopup"),i=f("div.esriPopup div.titlePane div.title"),t=f("div.esriPopup div.outerPointer, div.esriPopup div.pointer"),e.length>0&&i.length>0&&(d.set(i[0],"cursor","move"),a=new c(e[0],{handle:i[0]}),t.length>0&&(a.onMoveStart=function(){s.forEach(t,function(e){h.remove(e,"left right top bottom topLeft topRight bottomLeft bottomRight")})}))},executeIdentifyTask:function(e){var i=e.mapPoint,t=this.createIdentifyParams(i),a=[],r=[],o=this.getSelectedLayer();if(!this.checkForGraphicInfoTemplate(e)){var f=s.filter(this.layers,function(i){return i.ref.id===e.graphic._layer.id})[0];if(!f)return;r.push(f);var d=new v;a.push(d.promise),d.resolve([{feature:e.graphic}])}this.map.infoWindow.hide(),this.map.infoWindow.clearFeatures(),e.shiftKey||e.ctrlKey||e.altKey||(s.forEach(this.layers,n.hitch(this,function(e){var i=this.getLayerIds(e,o);if(i.length>0){var s=n.clone(t);s.layerDefinitions=e.ref.layerDefinitions,s.layerIds=i,e.ref.timeInfo&&e.ref.timeInfo.timeExtent&&this.map.timeExtent&&(s.timeExtent=new g(this.map.timeExtent.startTime,this.map.timeExtent.endTime)),a.push(e.identifyTask.execute(s)),r.push(e)}})),a.length>0&&(this.map.infoWindow.setTitle(this.i18n.mapInfoWindow.identifyingTitle),this.map.infoWindow.setContent('<div class="loading"></div>'),this.map.infoWindow.show(i),l(a).then(n.hitch(this,"identifyCallback",r),n.hitch(this,"identifyError"))))},checkForGraphicInfoTemplate:function(e){if(e.graphic){var i=e.graphic._layer;if(i.infoTemplate||i.capabilities&&s.indexOf(i.capabilities.toLowerCase(),"data")<0)return!1;if(!this.ignoreOtherGraphics){if(!this.identifies.hasOwnProperty(i.id))return!1;if(isNaN(i.layerId)||!this.identifies[i.id].hasOwnProperty(i.layerId))return!1}}return!0},createIdentifyParams:function(e){var i=new p;return i.tolerance=this.identifyTolerance,i.returnGeometry=!0,i.layerOption=p.LAYER_OPTION_VISIBLE,i.geometry=e,i.mapExtent=this.map.extent,i.width=this.map.width,i.height=this.map.height,i.spatialReference=this.map.spatialReference,i},getSelectedLayer:function(){var e=this.allLayersId;if(this.parentWidget){var i=this.identifyFormDijit.get("value");i.identifyLayer&&""!==i.identifyLayer?e=i.identifyLayer:this.identifyLayerDijit.set("value",e)}return e},getLayerIds:function(e,i){var t=i.split(this.layerSeparator),a=this.allLayersId,r=e.ref,n=e.layerInfo.layerIds,l=[];return r.visible&&(t[0]!==a&&r.id!==t[0]||(t.length>1&&t[1]?l=[t[1]]:"esri.layers.FeatureLayer"!==r.declaredClass||isNaN(r.layerId)?r.layerInfos&&(l=this.getLayerInfos(r,n)):r.capabilities&&s.indexOf(r.capabilities.toLowerCase(),"data")>=0&&(l=[r.layerId]))),l},getLayerInfos:function(e,i){var t=[];return s.forEach(e.layerInfos,n.hitch(this,function(a){this.includeSubLayer(a,e,i)&&t.push(a.id)})),t},identifyCallback:function(e,i){var t=[];s.forEach(i,function(i,a){var r=e[a].ref;s.forEach(i,function(e){if(e.feature.geometry.spatialReference=this.map.spatialReference,void 0===e.feature.infoTemplate){var i=this.getInfoTemplate(r,null,e);if(!i)return;e.layerId&&r.layerInfos&&i.info.showAttachments&&(e.feature._layer=this.getFeatureLayerForDynamicSublayer(r,e.layerId)),e.feature.setInfoTemplate(i)}var a=this.getFormattedFeature(e.feature.infoTemplate,e.feature);t.push(a)},this)},this),this.map.infoWindow.setFeatures(t)},getFormattedFeature:function(e,i){return i.graphic&&(i=i.graphic),i&&e&&e.info&&s.forEach(e.info.fieldInfos,function(e){"function"==typeof e.formatter&&(i.attributes[e.fieldName]=e.formatter(i.attributes[e.fieldName],i.attributes,n.clone(i.geometry)))}),i},identifyError:function(e){this.map.infoWindow.hide(),o.publish("viewer/handleError",{source:"Identify",error:e})},handleRightClick:function(){this.executeIdentifyTask(this.mapRightClick)},getInfoTemplate:function(e,i,t){var a,r;t?i="number"==typeof t.layerId?t.layerId:e.layerId:null===i&&(i=e.layerId);var s=this.identifies;if(s.hasOwnProperty(e.id)){if(s[e.id].hasOwnProperty(i)&&(a=s[e.id][i])instanceof m)return a}else s[e.id]={};return r=n.mixin(this.createDefaultInfoTemplate(e,i,t),s[e.id][i]||{}),a=s[e.id][i]=new m(r),r.content&&a.setContent(r.content),s[e.id][i]},createDefaultInfoTemplate:function(e,i,t){var a=null,r=[],l=this.getLayerName(e);if(t&&(l=t.layerName),t&&t.feature){var o=t.feature.attributes;if(o)for(var f in o)o.hasOwnProperty(f)&&this.addDefaultFieldInfo(r,{fieldName:f,label:this.makeSentenceCase(f),visible:!0})}else if(e._outFields&&e._outFields.length&&"*"!==e._outFields[0]){var d=e.fields;s.forEach(e._outFields,n.hitch(this,function(e){var i=s.filter(d,function(i){return i.name===e});i.length>0&&this.addDefaultFieldInfo(r,{fieldName:i[0].name,label:i[0].alias,visible:!0})}))}else e.fields&&s.forEach(e.fields,n.hitch(this,function(e){this.addDefaultFieldInfo(r,{fieldName:e.name,label:e.alias===e.name?this.makeSentenceCase(e.name):e.alias,visible:!0})}));return r.length>0&&(a={title:l,fieldInfos:r,showAttachments:e.hasAttachments}),a},makeSentenceCase:function(e){if(!e.length)return"";e=e.toLowerCase().replace(/_/g," ").split(" ");for(var i=0;i<e.length;i++)e[i]=e[i].charAt(0).toUpperCase()+(e[i].substr(1).length?e[i].substr(1):"");return e.length?e.join(" "):e},addDefaultFieldInfo:function(e,i){var t=i.fieldName.toLowerCase();s.indexOf(this.excludedFields,t)<0&&e.push(i)},createIdentifyLayerList:function(){var e=null,i=[],t=this.identifyLayerDijit.get("value"),a=this.layerSeparator;s.forEach(this.layers,n.hitch(this,function(r){var l=r.ref,o=r.layerInfo.layerIds;if(l.visible){var f=this.getLayerName(r);"esri.layers.FeatureLayer"!==l.declaredClass||isNaN(l.layerId)?s.forEach(l.layerInfos,n.hitch(this,function(r){this.includeSubLayer(r,l,o)&&(i.push({name:f+" \\ "+r.name,id:l.id+a+r.id}),l.id+a+r.id===t&&(e=t))})):(i.push({name:f,id:l.id+a+l.layerId}),l.id+a+l.layerId===t&&(e=t))}})),i.sort(function(e,i){return e.name>i.name?1:i.name>e.name?-1:0}),this.identifyLayerDijit.set("disabled",i.length<1),i.length>0&&(i.unshift({name:this.i18n.labels.allVisibleLayers,id:"***"}),e||(e=i[0].id));var r=new u({data:i});this.identifyLayerDijit.set("store",r),this.identifyLayerDijit.set("value",e)},includeSubLayer:function(e,i,t){return null===e.subLayerIds&&(!(this.isDefaultLayerVisibility(i)&&!this.checkVisibilityRecursive(i,e.id))&&(!(s.indexOf(i.visibleLayers,e.id)<0)&&(!!this.layerVisibleAtCurrentScale(e)&&(!(t&&s.indexOf(t,e.id)<0)&&!(!this.createDefaultInfoTemplates&&!this.getInfoTemplate(i,e.id))))))},checkVisibilityRecursive:function(e,i){var t=s.filter(e.layerInfos,function(e){return e.id===i});if(t.length>0){var a=t[0];if(-1!==e.visibleLayers.indexOf(i)&&(-1===a.parentLayerId||this.checkVisibilityRecursive(e,a.parentLayerId)))return!0}return!1},isDefaultLayerVisibility:function(e){for(var i=0;i<e.layerInfos.length;i++){var t=e.layerInfos[i];if(t.defaultVisibility&&-1===e.visibleLayers.indexOf(t.id))return!1}return!0},getLayerName:function(e){var i=null;return e.layerInfo&&(i=e.layerInfo.title),i||s.forEach(this.layers,function(t){t.ref.id!==e.id||(i=t.layerInfo.title)}),i||!(i=e.name)&&e.ref&&(i=e.ref._titleForLegend),i},getFeatureLayerForDynamicSublayer:function(e,i){if(!e.layerInfos)return!1;var t=e.url+"/"+i;return this.featureLayers.hasOwnProperty(t)||(this.featureLayers[t]=new I(t)),this.featureLayers[t]},layerVisibleAtCurrentScale:function(e){var i=this.map.getScale();return!(0!==e.maxScale&&i<e.maxScale||0!==e.minScale&&i>e.minScale)},setMapClickMode:function(e){this.mapClickMode=e;var i=this.map;s.forEach(i.graphicsLayerIds,function(t){var a=i.getLayer(t);a&&("identify"===e?this.infoTemplates[a.id]&&(a.infoTemplate=n.clone(this.infoTemplates[a.id])):a.infoTemplate&&(this.infoTemplates[a.id]=n.clone(a.infoTemplate),a.infoTemplate=null))},this)}})});
//# sourceMappingURL=Identify.js.map