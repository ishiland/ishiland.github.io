/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/aspect","dojo/promise/all","dojo/Deferred","put-selector","dijit/Menu","dijit/layout/ContentPane","gis/dijit/FloatingTitlePane","gis/dijit/FloatingWidgetDialog"],function(e,t,i,n,a,o,r,s,d,l,p){return e(null,{legendLayerInfos:[],editorLayerInfos:[],identifyLayerInfos:[],layerControlLayerInfos:[],widgets:{},widgetTypes:["titlePane","contentPane","floating","domNode","invisible","map","layer","layout","loading"],postConfig:function(e){var t;if(e)t=new o,e.then(i.hitch(this,function(){a(this.createWidgets(["loading"])).then(t.resolve)}));else{var n=this.createWidgets(["loading"]);n&&n.length&&(t=a(n))}return this.inherited(arguments)||t},startup:function(){this.inherited(arguments),this.mapDeferred&&this.mapDeferred.then(i.hitch(this,"createWidgets",["map","layer"])),this.layoutDeferred&&a([this.mapDeferred,this.layoutDeferred]).then(i.hitch(this,"createWidgets",null))},createWidgets:function(e){var i,n=[];e=e||this.widgetTypes;for(var a in this.config.widgets)if(this.config.widgets.hasOwnProperty(a)){var o=this.config.widgets[a];o.widgetKey=o.widgetKey||o.id||a,o.include&&!this.widgets[o.widgetKey]&&t.indexOf(e,o.type)>=0&&(o.position=void 0!==o.position?o.position:1e4,"titlePane"!==o.type&&"contentPane"!==o.type||o.placeAt||(o.placeAt="left"),n.push(o),this.widgets[a]=!0)}for(var r in this.panes)this.panes.hasOwnProperty(r)&&"outer"!==r&&"center"!==r&&((i=function(e){return i=t.filter(n,function(t){return t.placeAt&&t.placeAt===e})}(r)).sort(function(e,t){return e.position-t.position}),i.length>0&&0!==i[0].position&&(i[0].position=0),t.forEach(i,function(e,t){this.widgetLoader(e,t)},this));(i=t.filter(n,function(e){return!e.placeAt})).sort(function(e,t){return e.position-t.position});var s=[];return t.forEach(i,function(e,t){var i=this.widgetLoader(e,t);i&&s.push(i)},this),s},widgetLoader:function(e,n){var a,r,s=this.widgetTypes;if(s=s.concat(this.config.widgetTypes||[]),t.indexOf(s,e.type)<0)return this.handleError({source:"Controller",error:'Widget type "'+e.type+'" ('+e.title+") at position "+n+" is not supported."}),null;n&&(e.position=n),e.watched=e.watched||"open","titlePane"!==e.type&&"contentPane"!==e.type&&"floating"!==e.type||(a=e.widgetKey+"_parent","titlePane"===e.type?r=this._createTitlePaneWidget(a,e):"contentPane"===e.type?(r=this._createContentPaneWidget(a,e),e.preload=!0):"floating"===e.type&&(r=this._createFloatingWidget(a,e)),e.parentWidget=r,e.preload=e.preload||r.get(e.watched)||"function"!=typeof r.watch,this._showWidgetLoader(r));var d=new o;return e.preload=void 0===e.preload||e.preload,e.preload?this._loadWidget(e,d):e.watchHandle=r.watch(e.watched,i.hitch(this,"_loadWidget",e,d)),d},_loadWidget:function(e,t){"string"==typeof e.options?require([e.options,e.path],i.hitch(this,function(i,n){this.createWidget(e,i,n),t.resolve()})):require([e.path],i.hitch(this,function(i){this.createWidget(e,e.options,i),t.resolve()})),e.watchHandle&&(e.watchHandle.unwatch(),e.watchHandle.remove())},createWidget:function(e,t,i){var n=e.widgetKey;if(n){var a=(t=this._setWidgetOptions(e,t)).parentWidget,o=this.widgets;"titlePane"===e.type||"contentPane"===e.type||"floating"===e.type?o[n]=new i(t,r("div")).placeAt(a.containerNode):"domNode"===e.type?o[n]=new i(t,e.srcNodeRef):o[n]=new i(t),o[n]&&o[n].startup&&!o[n]._started&&o[n].startup(),this._hideWidgetLoader(a)}},_setWidgetOptions:function(e,t){return e.id&&(t.id=e.id+"_widget"),t.parentWidget=e.parentWidget,t.map&&(t.map=this.map),t.mapRightClickMenu&&(this.mapRightClickMenu||(this.mapRightClickMenu=new s({targetNodeIds:[this.map.root],selector:".esriMapLayers"}),this.mapRightClickMenu.startup()),t.mapRightClickMenu=this.mapRightClickMenu),t.mapClickMode&&(t.mapClickMode=this.mapClickMode.current),t.legendLayerInfos&&(t.layerInfos=this.legendLayerInfos),t.layerControlLayerInfos&&(t.layerInfos=this.layerControlLayerInfos),t.editorLayerInfos&&(t.layerInfos=this.editorLayerInfos),t.identifyLayerInfos&&(t.layerInfos=this.identifyLayerInfos),t},_showWidgetLoader:function(e){e&&e.containerNode&&(e.loadingNode=r(e.containerNode,"div.widgetLoader i.fa.fa-spinner.fa-pulse.fa-fw").parentNode)},_hideWidgetLoader:function(e){e&&e.loadingNode&&require(["dojo/domReady!"],function(){r(e.loadingNode,"!")})},_createTitlePaneWidget:function(e,t){var n,a=i.mixin({title:t.title||"Widget",iconClass:t.iconClass,open:t.open||!1,canFloat:t.canFloat||!1,resizable:t.resizable||!1},t.paneOptions||{});e&&(a.id=e);var o=t.placeAt;return"string"==typeof o&&(o=this.panes[o]),o||(o=this.panes.left),o&&(a.sidebar=o,(n=new l(a).placeAt(o,t.position)).startup()),n},_createFloatingWidget:function(e,t){var n=i.mixin({title:t.title,iconClass:t.iconClass},t.paneOptions||{});e&&(n.id=e);var a=new p(n);return a.startup(),a},_createContentPaneWidget:function(e,t){var n,a=i.mixin({title:t.title,region:t.region||"center"},t.paneOptions||{});t.className&&(a.className=t.className),e&&(a.id=e);var o=t.placeAt;return o?"string"==typeof o&&(o=this.panes[o]):o=this.panes.left,o&&(n=new d(a).placeAt(o)).startup(),n}})});
//# sourceMappingURL=_WidgetsMixin.js.map