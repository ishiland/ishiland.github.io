/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/lang","dojo/on","dojo/dom","dojo/_base/array","dojo/Deferred","esri/map","esri/IdentityManager"],function(e,r,i,t,a,s,n){return e(null,{postConfig:function(){return this.mapDeferred=new s,this.inherited(arguments)},startup:function(){this.inherited(arguments),this.layoutDeferred.then(r.hitch(this,"initMapAsync"))},initMapAsync:function(){var e=new s,i=[];return this.createMap(i).then(r.hitch(this,"_createMapResult",e,i)),e.then(r.hitch(this,"initMapComplete")),e},createMap:function(e){var r=this.inherited(arguments);if(r)return r;var i=new s,a=t.byId(this.config.layout.map)||"mapCenter";this.map=new n(a,this.config.mapOptions);var o=this.inherited(arguments);return o?o.then(function(r){r&&(e=e.concat(r)),i.resolve(e)}):i.resolve(e),i},_createMapResult:function(e,t){return this.map?(!this.config.webMapId&&this.config.mapOptions&&this.config.mapOptions.basemap?this.map.on("load",r.hitch(this,"_initLayers",t)):this._initLayers(t),this.config.operationalLayers&&this.config.operationalLayers.length>0?i.once(this.map,"layers-add-result",r.hitch(this,"_onLayersAddResult",e,t)):e.resolve(t)):e.resolve(t),e},_onLayersAddResult:function(e,r,i){a.forEach(i.layers,function(e){!0!==e.success&&r.push(e.error)},this),e.resolve(r)},_initLayers:function(e){this.layers=[];var i={csv:"esri/layers/CSVLayer",dataadapter:"esri/layers/DataAdapterFeatureLayer",dynamic:"esri/layers/ArcGISDynamicMapServiceLayer",feature:"esri/layers/FeatureLayer",georss:"esri/layers/GeoRSSLayer",graphics:"esri/layers/GraphicsLayer",image:"esri/layers/ArcGISImageServiceLayer",imagevector:"esri/layers/ArcGISImageServiceVectorLayer",kml:"esri/layers/KMLLayer",mapimage:"esri/layers/MapImageLayer",osm:"esri/layers/OpenStreetMapLayer",raster:"esri/layers/RasterLayer",stream:"esri/layers/StreamLayer",tiled:"esri/layers/ArcGISTiledMapServiceLayer",vectortile:"esri/layers/VectorTileLayer",webtiled:"esri/layers/WebTiledLayer",wfs:"esri/layers/WFSLayer",wms:"esri/layers/WMSLayer",wmts:"esri/layers/WMTSLayer"};i=r.mixin(i,this.config.layerTypes||{});var t=[];a.forEach(this.config.operationalLayers,function(r){var a=i[r.type];a?t.push(a):e.push('Layer type "'+r.type+'" is not supported: ')},this),require(t,r.hitch(this,function(){a.forEach(this.config.operationalLayers,function(e){var t=i[e.type];t&&require([t],r.hitch(this,"_initLayer",e))},this),this.map.addLayers(this.layers)}))},_initLayer:function(e,i){var t;t=e.url?new i(e.url,e.options):new i(e.options),this.layers.unshift(t);var a=!1;if(void 0!==e.legendLayerInfos&&void 0!==e.legendLayerInfos.exclude&&(a=e.legendLayerInfos.exclude),!a){var s={};void 0!==e.legendLayerInfos&&void 0!==e.legendLayerInfos.layerInfo&&(s=e.legendLayerInfos.layerInfo);var n=r.mixin({layer:t,title:e.title||null},s);this.legendLayerInfos.unshift(n)}if(this.layerControlLayerInfos.unshift({layer:t,type:e.type,title:e.title,controlOptions:e.layerControlLayerInfos}),"feature"===e.type){var o={featureLayer:t};e.editorLayerInfos&&r.mixin(o,e.editorLayerInfos),!0!==o.exclude&&this.editorLayerInfos.push(o)}if("dynamic"===e.type||"feature"===e.type){var y={layer:t,title:e.title};e.identifyLayerInfos&&r.mixin(y,e.identifyLayerInfos),!0!==y.exclude&&this.identifyLayerInfos.push(y)}},initMapComplete:function(e){e&&e.length>0&&this.handleError({source:"Controller",error:e.join(", ")}),this.map&&(this.map.on("resize",function(e){var r=e.target.extent.getCenter();setTimeout(function(){e.target.centerAt(r)},100)}),this.mapDeferred.resolve(this.map))},initMapError:function(e){this.handleError({source:"Controller",error:e})},resizeMap:function(){this.map&&this.map.resize()},getMapHeight:function(){return this.map?this.map.height:0}})});
//# sourceMappingURL=_MapMixin.js.map