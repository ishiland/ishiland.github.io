/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/lang","dojo/on","dojo/dom","dojo/_base/array","dojo/Deferred","esri/map","esri/IdentityManager"],function(e,l,h,s,n,o,y){return e(null,{postConfig:function(){return this.mapDeferred=new o,this.inherited(arguments)},startup:function(){this.ignoreDynamicGroupVisibility=!1!==this.config.ignoreDynamicGroupVisibility,this.inherited(arguments),this.layoutDeferred.then(l.hitch(this,"initMapAsync"))},initMapAsync:function(){var e=new o,r=[];return this.createMap(r).then(l.hitch(this,"_createMapResult",e,r)),e.then(l.hitch(this,"initMapComplete")),e},createMap:function(r){var e=this.inherited(arguments);if(e)return e;var i=new o,t=s.byId(this.config.layout.map)||"mapCenter";this.map=new y(t,this.config.mapOptions);var a=this.inherited(arguments);return a?a.then(function(e){e&&(r=r.concat(e)),i.resolve(r)}):i.resolve(r),i},_createMapResult:function(e,r){return this.map?(!this.config.webMapId&&this.config.mapOptions&&this.config.mapOptions.basemap?this.map.on("load",l.hitch(this,"_initLayers",r)):this._initLayers(r),this.config.operationalLayers&&0<this.config.operationalLayers.length?h.once(this.map,"layers-add-result",l.hitch(this,"_onLayersAddResult",e,r)):e.resolve(r)):e.resolve(r),e},_onLayersAddResult:function(e,r,i){n.forEach(i.layers,function(e){!0!==e.success&&r.push(e.error)},this),e.resolve(r)},_initLayers:function(i){this.layers=[];var t={csv:"esri/layers/CSVLayer",dataadapter:"esri/layers/DataAdapterFeatureLayer",dynamic:"esri/layers/ArcGISDynamicMapServiceLayer",feature:"esri/layers/FeatureLayer",georss:"esri/layers/GeoRSSLayer",graphics:"esri/layers/GraphicsLayer",image:"esri/layers/ArcGISImageServiceLayer",imagevector:"esri/layers/ArcGISImageServiceVectorLayer",kml:"esri/layers/KMLLayer",mapimage:"esri/layers/MapImageLayer",osm:"esri/layers/OpenStreetMapLayer",raster:"esri/layers/RasterLayer",stream:"esri/layers/StreamLayer",tiled:"esri/layers/ArcGISTiledMapServiceLayer",vectortile:"esri/layers/VectorTileLayer",webtiled:"esri/layers/WebTiledLayer",wfs:"esri/layers/WFSLayer",wms:"esri/layers/WMSLayer",wmts:"esri/layers/WMTSLayer"};t=l.mixin(t,this.config.layerTypes||{});var a=[];n.forEach(this.config.operationalLayers,function(e){var r=t[e.type];r?a.push(r):i.push('Layer type "'+e.type+'" is not supported: ')},this),require(a,l.hitch(this,function(){n.forEach(this.config.operationalLayers,function(e){var r=t[e.type];r&&require([r],l.hitch(this,"_initLayer",e))},this),this.map.addLayers(this.layers)}))},_initLayer:function(e,r){var i=null;try{i=e.url?new r(e.url,e.options):new r(e.options),this.layers.unshift(i)}catch(e){this.handleError({source:"_MapMixin._initLayer",error:e})}var t=!1;if(void 0!==e.legendLayerInfos&&void 0!==e.legendLayerInfos.exclude&&(t=e.legendLayerInfos.exclude),!t){var a={};void 0!==e.legendLayerInfos&&void 0!==e.legendLayerInfos.layerInfo&&(a=e.legendLayerInfos.layerInfo);var s=l.mixin({layer:i,title:e.title||null},a);this.legendLayerInfos.unshift(s)}var n=l.mixin({ignoreDynamicGroupVisibility:this.ignoreDynamicGroupVisibility},e.layerControlLayerInfos);if(this.layerControlLayerInfos.unshift({layer:i,type:e.type,title:e.title,controlOptions:n}),"feature"===e.type){var o={featureLayer:i};e.editorLayerInfos&&l.mixin(o,e.editorLayerInfos),!0!==o.exclude&&this.editorLayerInfos.push(o)}if("dynamic"===e.type&&this.ignoreDynamicGroupVisibility&&h(i,"load",l.hitch(this,"removeGroupLayers")),"dynamic"===e.type||"feature"===e.type){var y={layer:i,title:e.title,ignoreDynamicGroupVisibility:this.ignoreDynamicGroupVisibility};e.identifyLayerInfos&&l.mixin(y,e.identifyLayerInfos),!0!==y.exclude&&this.identifyLayerInfos.push(y)}},removeGroupLayers:function(e){var i=[],t=!1,a=e.layer,r=a.visibleLayers||a._defaultVisibleLayers;n.forEach(r,function(r){var e=n.filter(a.layerInfos,function(e){return e.id===r})[0];e&&null===e.subLayerIds?i.push(r):t=!0}),0<i.length&&t&&a.setVisibleLayers(i)},initMapComplete:function(e){e&&0<e.length&&this.handleError({source:"Controller",error:e.join(", ")}),this.map&&(this.map.on("resize",function(e){var r=e.target.extent.getCenter();setTimeout(function(){e.target.centerAt(r)},100)}),this.mapDeferred.resolve(this.map))},initMapError:function(e){this.handleError({source:"Controller",error:e})},resizeMap:function(){this.map&&this.map.resize()},getMapHeight:function(){return this.map?this.map.height:0}})});
//# sourceMappingURL=_MapMixin.js.map