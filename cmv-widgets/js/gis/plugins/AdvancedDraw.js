/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dojo/text!./AdvancedDraw/templates/AdvancedDraw.html","./AdvancedDraw/advancedDrawConfig","dojo/i18n!./AdvancedDraw/nls/resource","dojo/_base/declare","dojo/_base/lang","dojo/on","dojo/topic","dojo/keys","dojo/html","dojo/dom","dojo/dom-geometry","dojo/dom-class","esri/toolbars/draw","esri/toolbars/edit","esri/layers/GraphicsLayer","esri/layers/FeatureLayer","esri/symbols/jsonUtils","esri/graphic","esri/geometry/Polygon","esri/geometry/screenUtils","esri/geometry/webMercatorUtils","esri/undoManager","./AdvancedDraw/undo/addGraphicOp","./AdvancedDraw/undo/deleteGraphicOp","./AdvancedDraw/undo/editGeometryGraphicOp","./AdvancedDraw/widget/TextTooltipDialog","./AdvancedDraw/widget/DefaultSymbolEditors","./AdvancedDraw/widget/GraphicSymbolEditor","dijit/popup","dijit/Menu","dijit/MenuItem","dijit/PopupMenuItem","dijit/CheckedMenuItem","dijit/layout/StackContainer","dijit/layout/TabContainer","dijit/layout/ContentPane","dijit/Toolbar","dijit/form/CheckBox","dijit/form/Button","dijit/form/DropDownButton","dijit/form/ComboButton","dijit/form/ToggleButton","xstyle/css!./AdvancedDraw/css/AdvancedDraw.css","xstyle/css!./AdvancedDraw/css/adw-icons.css"],function(e,t,i,a,o,l,n,r,d,s,c,h,p,y,u,w,_,m,g,f,b,C,k,D,x,v,T,S,L,M,E,G,P,j,B,N){return n([e,t,i],{templateString:a,name:"advancedDraw",baseClass:"AdvancedDrawWidget",widgetsInTemplate:!0,mapClickMode:null,_params:{map:null,config:null,stickyLayers:!0,stickyPosition:"bottom",_layers:{polygon:null,polyline:null,point:null,text:null,temp:null},_layersLoaded:!1,_symbols:{polygon:null,polyline:null,point:null,text:null,temp:null},_drawButtonClickHandler:null,_snappingMenuItem:null,_continuousDrawMenuItem:null,_continuousDraw:!1,_isTextPoint:!1,_drawMenu:null,_undo:null,manualLayerLoad:!1},constructor:function(e){r.mixin(this,this._params,e||{}),this.i18n=l},postCreate:function(){this.inherited(arguments),this.own(s.subscribe("mapClickMode/currentSet",r.hitch(this,"setMapClickMode"))),this.map?(!0!==this.stickyLayers&&!1!==this.stickyLayers&&(this.stickyLayers=!0),"top"!==this.stickyPosition&&"bottom"!==this.stickyPosition&&(this.stickyPosition="bottom"),this.stackNode.startup(),this.config=r.mixin(o,this.config||{}),this.map.loaded?this._initialize(this.config,this.map):this.map.on("load",r.hitch(this,"_initialize",this.config,this.map))):this.destroy()},_initialize:function(e,t){this._drawTb=new w(t),this._drawTb.on("draw-complete",r.hitch(this,"_drawComplete")),this._editTb=new _(t),this._initLayers(e,t,this._layers),this._initDefaultSymbols(e),this._drawMenu=this._initDrawMenu(),this.drawButton.set("dropDown",this._drawMenu),this._drawButtonClickHandler=d(this.drawButton,"click",r.hitch(this,"_draw","point")),this._optionsMenu=this._initOptionsMenu(),this.optionsButton.set("dropDown",this._optionsMenu),this._initDrawKeys(),this._initSnapping(),this._undo=new x({maxOperations:-1}),this.undoButton.on("click",r.hitch(this,function(){this._undo.undo()})),this.redoButton.on("click",r.hitch(this,function(){this._undo.redo()}))},_initLayers:function(e,t,i){if(i.polygon=new g({layerDefinition:r.mixin(e._layerDefinition,{geometryType:"esriGeometryPolygon",name:"AdvancedDrawPolygon"}),featureSet:{features:[]},showLegend:!1},{id:"advanced_draw_polygon",mode:0}),i.polyline=new g({layerDefinition:r.mixin(e._layerDefinition,{geometryType:"esriGeometryPolyline",name:"AdvancedDrawPolyline"}),featureSet:{features:[]},showLegend:!1},{id:"advanced_draw_polyline",mode:0}),i.point=new g({layerDefinition:r.mixin(e._layerDefinition,{geometryType:"esriGeometryPoint",name:"AdvancedDrawPoint"}),featureSet:{features:[]},showLegend:!1},{id:"advanced_draw_point",mode:0}),i.text=new g({layerDefinition:r.mixin(e._layerDefinition,{geometryType:"esriGeometryPoint",name:"AdvancedDrawText"}),featureSet:{features:[]},showLegend:!1},{id:"advanced_draw_text",mode:0}),i.temp=new m({id:"advanced_draw_temp"}),this.stickyLayers&&(this._stickyLayersHandler=d.pausable(this.map,"layer-add, layer-reorder, layers-add-result",r.hitch(this,"_stickyLayers"))),this.stickyLayers&&"bottom"===this.stickyPosition||!this.stickyLayers)t.addLayer(i.polygon,0),t.addLayer(i.polyline,1),t.addLayer(i.point,2),t.addLayer(i.text,3),t.addLayer(i.temp,4);else{var a=t.graphicsLayerIds.length;t.addLayer(i.polygon,a),t.addLayer(i.polyline,a+1),t.addLayer(i.point,a+2),t.addLayer(i.text,a+3),t.addLayer(i.temp,a+4)}for(var o in this._layersLoaded=!0,i)i.hasOwnProperty(o)&&"temp"!==o&&this._initLayerMenuEvents(i[o])},_stickyLayers:function(){this._stickyLayersHandler.pause();var e=this.map,t=this._layers;if("bottom"===this.stickyPosition)e.addLayer(t.polygon,0),e.addLayer(t.polyline,1),e.addLayer(t.point,2),e.addLayer(t.text,3),e.addLayer(t.temp,4);else{var i=e.graphicsLayerIds.length-4;e.addLayer(t.polygon,i),e.addLayer(t.polyline,i+1),e.addLayer(t.point,i+2),e.addLayer(t.text,i+3),e.addLayer(t.temp,i+4)}this._stickyLayersHandler.resume()},_initDefaultSymbols:function(e){this._symbols.polygon=f.fromJson(e.defaultPolygonSymbol),this._symbols.polyline=f.fromJson(e.defaultPolylineSymbol),this._symbols.point=f.fromJson(e.defaultPointSymbol),this._symbols.text=f.fromJson(e.defaultTextSymbol),this._symbols.temp=f.fromJson(e.defaultTempSymbol),this._defaultSymbolEditors=new M({symbols:this._symbols,colorPickerOptions:this.config.colorPickerOptions},this.defaultSymbolEditorsNode),this._defaultSymbolEditors.startup()},_initDrawMenu:function(){var e=new P;e.addChild(new j({label:l.point,iconClass:"adw-icon-point",onClick:r.hitch(this,"_draw","point")})),e.addChild(new j({label:l.polyline,iconClass:"adw-icon-polyline",onClick:r.hitch(this,"_draw","polyline")})),e.addChild(new j({label:l.polygon,iconClass:"adw-icon-polygon",onClick:r.hitch(this,"_draw","polygon")})),e.addChild(new j({label:l.text,iconClass:"adw-icon-text",onClick:r.hitch(this,"_draw","text")}));var t=new P;t.addChild(new j({label:l.polyline,iconClass:"adw-icon-freehand-polyline",onClick:r.hitch(this,"_draw","freehandpolyline")})),t.addChild(new j({label:l.polygon,iconClass:"adw-icon-freehand-polygon",onClick:r.hitch(this,"_draw","freehandpolygon")})),t.startup(),e.addChild(new B({label:l.freehand,iconClass:"adw-icon-freehand-polyline",popup:t}));var i=new P;return i.addChild(new j({label:l.rectangle,iconClass:"adw-icon-rectangle",onClick:r.hitch(this,"_draw","extent")})),i.addChild(new j({label:l.circle,iconClass:"adw-icon-circle",onClick:r.hitch(this,"_draw","circle")})),i.startup(),e.addChild(new B({label:l.shapes,iconClass:"adw-icon-rectangle",popup:i})),e.startup(),e},_initOptionsMenu:function(){var e=new P;return this._snappingMenuItem=new N({checked:!0,label:l.snapping}),e.addChild(this._snappingMenuItem),e.startup(),e},_initDrawKeys:function(){d(document,"keypress",r.hitch(this,function(e){if(e.keyCode&&99===e.keyCode){var t=this.continuousToggleNode;t.get("disabled")||t.set("checked",!t.checked)}if(e.keyCode&&115===e.keyCode){var i=this.snappingToggleNode;i.get("disabled")||i.set("checked",!i.checked)}}))},_setDrawButton:function(e){this.disconnectMapClick(),this._drawButtonClickHandler.remove(),this._drawButtonClickHandler=d(this.drawButton,"click",r.hitch(this,"_draw",e));var t=l[e];"extent"===e&&(t=l.rectangle),this.drawButton.set("title",t)},_draw:function(e){switch(this._drawTb._geometryType&&this._drawTb.deactivate(),this._isTextPoint=!1,e){case"point":this._defaultSymbolEditors.showSMSEditor(),this._updateDrawLabelClass("adw-icon-point");break;case"polyline":this._updateDrawLabelClass("adw-icon-polyline"),this._defaultSymbolEditors.showSLSEditor();break;case"freehandpolyline":this._defaultSymbolEditors.showSLSEditor(),this._updateDrawLabelClass("adw-icon-freehand-polyline");break;case"polygon":this._updateDrawLabelClass("adw-icon-polygon"),this._defaultSymbolEditors.showSFSEditor();break;case"freehandpolygon":this._updateDrawLabelClass("adw-icon-freehand-polygon"),this._defaultSymbolEditors.showSFSEditor();break;case"extent":this._updateDrawLabelClass("adw-icon-rectangle"),this._defaultSymbolEditors.showSFSEditor();break;case"circle":this._defaultSymbolEditors.showSFSEditor(),this._updateDrawLabelClass("adw-icon-circle");break;case"text":this._defaultSymbolEditors.showSFSEditor(),this._updateDrawLabelClass("adw-icon-text");break;default:this._defaultSymbolEditors.showSMSEditor(),this._updateDrawLabelClass("adw-icon-point")}this._setDrawButton(e),this.cancelButton.set("disabled",!1),this.snappingToggleNode.set("disabled",!0),this.continuousToggleNode.set("disabled",!0),"extent"===e?h.set(this.drawStatusNode,l.rectangle):"text"===e?(h.set(this.drawStatusNode,l.text),this._isTextPoint=!0,e="point"):h.set(this.drawStatusNode,l[e]),this._drawTb.activate(e)},_updateDrawLabelClass:function(e){this.drawButton.set("iconClass",e)},_drawComplete:function(e){if(this.connectMapClick(),this._continuousDraw||this._drawCancel(),this._isTextPoint)this._continuousDraw||(this._isTextPoint=!1),this._drawText(e);else{var t=e.geometry,i=e.geographicGeometry,a=t.type;"extent"===a&&(t=this._extentToPolygon(t),i&&(i=this._extentToPolygon(i)),a="polygon");var o=new b(i||t,this._symbols[a],{OBJECTID:(new Date).getTime(),draw_type:a,draw_text_string:null},null);this._layers[a].add(o),this._undo.add(new v({layer:o.getLayer(),graphic:o}))}},_extentToPolygon:function(e){var t=new C(e.spatialReference);return t.addRing([[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin],[e.xmin,e.ymax]]),t},_drawText:function(e){var t=e.geometry,i=e.geographicGeometry,a=new b(i||t,this._symbols.text,{OBJECTID:(new Date).getTime(),draw_type:"text",draw_text_string:"New Text"},null);a._advancedDrawTextTooltipDialog=new L({_graphic:a,i18n:l}),this._layers.text.add(a),this._undo.add(new v({layer:a.getLayer(),graphic:a})),this._popupTextTooltip(this.map,a,t)},_popupTextTooltip:function(e,t,i){var a=k.toScreenGeometry(e.extent,e.width,e.height,i),o=y.position(p.byId(e.id),!1);G.open({popup:t._advancedDrawTextTooltipDialog,x:a.x+o.x+this.config._textTooltipDialogOffset.x,y:a.y+o.y+this.config._textTooltipDialogOffset.y})},_drawCancel:function(){this._drawTb.deactivate(),this.cancelButton.set("disabled",!0),this.snappingToggleNode.set("disabled",!1),this.continuousToggleNode.set("disabled",!1),h.set(this.drawStatusNode,l.none)},_initLayerMenuEvents:function(e){e.on("mouse-over",function(e){e.graphic._advancedDrawMenu.bindDomNode(e.graphic.getDojoShape().getNode())}),e.on("mouse-out",function(e){e.graphic._advancedDrawMenu.unBindDomNode(e.graphic.getDojoShape().getNode())}),e.on("graphic-add",r.hitch(this,function(e){this._addGraphicMenu(e.graphic)}))},_addGraphicMenu:function(e){if(!e._advancedDrawMenu){var t=this.map,i=e.attributes.draw_type,a=new P({contextMenuForWindow:!1,leftClickToOpen:!1});if("text"===i){e._advancedDrawTextTooltipDialog||(e._advancedDrawTextTooltipDialog=new L({graphic:e,i18n:l}),e._textTooltip.textNode.set("value",e.symbol.text));var o=t.spatialReference.isWebMercator()?D.geographicToWebMercator(e.geometry):e.geometry;a.addChild(new j({label:"Edit Text",onClick:r.hitch(this,"_popupTextTooltip",t,e,o)}))}a.addChild(new j({label:"Edit Symbol",onClick:r.hitch(this,"_editGraphicSymbol",e)}));var n=new P,d=this._editTb.constructor;if(n.addChild(new j({label:"Move",onClick:r.hitch(this,"_editGraphicGeometry",e,d.MOVE)})),"polyline"===i||"polygon"===i){n.addChild(new j({label:"Edit Vertices",onClick:r.hitch(this,"_editGraphicGeometry",e,d.EDIT_VERTICES)}));var s=new P;s.addChild(new j({label:"Uniform Scale",onClick:r.hitch(this,"_editGraphicGeometry",e,d.SCALE,!0)})),s.addChild(new j({label:"Freeform Scale",onClick:r.hitch(this,"_editGraphicGeometry",e,d.SCALE,!1)})),s.startup(),n.addChild(new B({label:"Scale",popup:s})),n.addChild(new j({label:"Rotate",onClick:r.hitch(this,"_editGraphicGeometry",e,d.ROTATE)}))}n.addChild(new j({label:"Delete",onClick:r.hitch(this,"_deleteGraphic",e)})),n.startup(),a.addChild(new B({label:"Edit Geometry",popup:n})),a.addChild(new j({label:"Move to Front",onClick:function(){e.getDojoShape().moveToFront()}})),a.addChild(new j({label:"Move to Back",onClick:function(){e.getDojoShape().moveToBack()}})),a.startup(),a.on("focus",r.hitch(this,"_identifyGraphic",e)),e._advancedDrawMenu=a}},_editGraphicGeometry:function(e,t,i){var a=this.config._editGeometryOptions;4===t&&(a.uniformScaling=i);var o=r.clone(e.geometry);this._editTb.activate(t,e,a),d.once(this.map,"click",r.hitch(this,function(){this._editTb.getCurrentState().isModified&&this._undo.add(new S({graphic:e,startGeom:o,endGeom:this._editTb.getCurrentState().graphic.geometry})),this._editTb.deactivate()}))},_identifyGraphic:function(e){var t=this._layers.temp;t.clear(),t.add(new b(this.map.extent,f.fromJson(this.config.defaultTempSymbol))),t.add(new b(e.geometry,e.symbol)),e._advancedDrawMenu.on("blur",function(){t.clear()})},_deleteGraphic:function(e){var t=e.getLayer();this._undo.add(new T({layer:t,graphic:e})),t.remove(e)},_editGraphicSymbol:function(e){var t=new E({graphic:e,colorPickerOptions:this.config.colorPickerOptions});d(t,"hide",r.hitch(this,function(){this._addUndoOp(t.undoOp),t.destroy()})),t.show()},_addUndoOp:function(e){e&&this._undo.add(e)},_initSnapping:function(){var e=this.config._snappingOptions;e.snapPointSymbol=f.fromJson(e.snapPointSymbol),e.snapKey&&(e.snapKey=c[e.snapKey]),this.map.enableSnapping(e),this.map.on("layer-add, layers-add-result",r.hitch(this,"_toggleSnapping"))},_toggleSnapping:function(){var e=this.snappingToggleNode;e.checked?(this.map.enableSnapping(this.config._snappingOptions),u.add(e.iconNode,"fa-check")):(this.map.disableSnapping(),u.remove(e.iconNode,"fa-check"))},_toggleContinuousDraw:function(){var e=this.continuousToggleNode;e.checked?(this._continuousDraw=!0,u.add(e.iconNode,"fa-check")):(this._continuousDraw=!1,u.remove(e.iconNode,"fa-check"))},setMapClickMode:function(e){this.mapClickMode=e},disconnectMapClick:function(){s.publish("mapClickMode/setCurrent","advancedDraw")},connectMapClick:function(){s.publish("mapClickMode/setDefault")},_setPane:function(e,t){this.stackNode.selectChild(t?e:this.defaultPane)}})});
//# sourceMappingURL=AdvancedDraw.js.map