/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/MenuItem","dojo/_base/lang","dojo/_base/array","dojo/promise/all","dojo/topic","dojo/query","dojo/dom-style","dojo/dom-class","dojo/dnd/Moveable","dojo/store/Memory","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/dijit/PopupTemplate","esri/layers/FeatureLayer","esri/TimeExtent","dojo/Deferred","dojo/text!./Identify/templates/Identify.html","dojo/i18n!./Identify/nls/resource","./Identify/Formatters","dijit/form/Form","dijit/form/FilteringSelect","xstyle/css!./Identify/css/Identify.css"],function(e,i,t,a,r,f,d,o,h,n,s,l,u,c,y,p,m,I,g,v,b,L,T){return e([i,t,a],{widgetsInTemplate:!0,templateString:b,baseClass:"gis_IdentifyDijit",i18n:L,mapClickMode:null,identifies:{},infoTemplates:{},featureLayers:{},ignoreOtherGraphics:!0,createDefaultInfoTemplates:!0,showPopup:!0,draggable:!1,returnFieldName:!1,returnUnformattedValues:!1,layerSeparator:"||",allLayersId:"***",excludedFields:["objectid","esri_oid","shape","shape.len","shape_length","shape_len","shape.stlength()","shape.area","shape_area","shape.starea()"],defaultFormatters:{esriFieldTypeSmallInteger:T.formatInt,esriFieldTypeInteger:T.formatInt,esriFieldTypeSingle:T.formatFloat,esriFieldTypeDouble:T.formatFloat,esriFieldTypeDate:T.formatDate},postCreate:function(){this.inherited(arguments),this.identifies||(this.identifies={}),this.layers=[],this.addLayerInfos(this.layerInfos),this.own(h.subscribe("mapClickMode/currentSet",f.hitch(this,"setMapClickMode"))),this.own(h.subscribe("identify/addLayerInfos",f.hitch(this,"addLayerInfos"))),this.own(h.subscribe("identify/removeLayerInfos",f.hitch(this,"removeLayerInfos"))),this.map.on("click",f.hitch(this,function(e){"identify"===this.mapClickMode&&this.executeIdentifyTask(e)})),this.mapRightClickMenu&&this.addRightClickMenu(),this.parentWidget&&(this.createIdentifyLayerList(),this.map.on("update-end",f.hitch(this,function(){this.createIdentifyLayerList()}))),this.draggable&&this.setupDraggable()},addLayerInfos:function(e){d.forEach(e,f.hitch(this,"addLayerInfo"))},addLayerInfo:function(t){var e=t.layer.id,a=this.map.getLayer(e),i=null;if(a){var r=a.url;if("esri.layers.FeatureLayer"===a.declaredClass){if(a.capabilities&&d.indexOf(a.capabilities.toLowerCase(),"data")<0&&!a.infoTemplate&&(i=this.getInfoTemplate(a,a.layerId))){a.setInfoTemplate(i);var n=i.info.fieldInfos;0<d.filter(n,function(e){return e.formatter}).length&&a.on("graphic-draw",f.hitch(this,"getFormattedFeature",a.infoTemplate))}if(r){var s=r.lastIndexOf("/"+a.layerId);0<s&&(r=r.substring(0,s))}}else a.layerInfos&&d.forEach(a.layerInfos,f.hitch(this,function(e){var i=e.id;(null===t.layerIds||0<=d.indexOf(t.layerIds,i))&&this.getFeatureLayerForDynamicSublayer(a,i)}));var l=[];if(this.parentWidget){var o=a.on("visibility-change",f.hitch(this,function(e){!1===e.visible&&this.createIdentifyLayerList()}));l.push(o)}this.layers.push({ref:a,layerInfo:t,identifyTask:r?new y(r):null,listeners:l})}},removeLayerInfos:function(e){d.forEach(e,f.hitch(this,"removeLayerInfo"))},removeLayerInfo:function(e){var i=e.id,t=[],a=null;d.forEach(this.layers,function(e){e.ref.id!==i?t.push(e):a=e.listeners}),t.length!==this.layers.length&&(this.layers=t),a&&d.forEach(a,function(e){e.remove&&e.remove()})},addRightClickMenu:function(){this.map.on("MouseDown",f.hitch(this,function(e){this.mapRightClick=e})),this.mapRightClickMenu.addChild(new r({label:this.i18n.rightClickMenuItem.label,onClick:f.hitch(this,"handleRightClick")}))},setupDraggable:function(){var e,i,t,a=null;e=n("div.esriPopup"),i=n("div.esriPopup div.titlePane div.title"),t=n("div.esriPopup div.outerPointer, div.esriPopup div.pointer"),0<e.length&&0<i.length&&(s.set(i[0],"cursor","move"),a=new u(e[0],{handle:i[0]}),0<t.length&&(a.onMoveStart=function(){d.forEach(t,function(e){l.remove(e,"left right top bottom topLeft topRight bottomLeft bottomRight")})}))},executeIdentifyTask:function(i){var e=i.mapPoint,a=this.createIdentifyParams(e),r=[],n=[],s=this.getSelectedLayer();if(!this.checkForGraphicInfoTemplate(i)){var t=d.filter(this.layers,function(e){return e.ref.id===i.graphic._layer.id})[0];if(!t)return h.publish("identify/results",{features:[{feature:i.graphic}]}),void(this.showPopup||this.map.infoWindow.hide());n.push(t);var l=new v;r.push(l.promise),l.resolve([{feature:i.graphic}])}this.map.infoWindow.hide(),this.map.infoWindow.clearFeatures(),i.shiftKey||i.ctrlKey||i.altKey||(d.forEach(this.layers,f.hitch(this,function(e){var i=this.getLayerIds(e,s);if(0<i.length){var t=f.clone(a);t.layerDefinitions=e.ref.layerDefinitions,t.layerIds=i,t.returnFieldName=void 0!==e.layerInfo.returnFieldName?e.layerInfo.returnFieldName:this.returnFieldName,t.returnUnformattedValues=void 0!==e.layerInfo.returnUnformattedValues?e.layerInfo.returnUnformattedValues:this.returnUnformattedValues,e.ref.timeInfo&&e.ref.timeInfo.timeExtent&&this.map.timeExtent&&(t.timeExtent=new g(this.map.timeExtent.startTime,this.map.timeExtent.endTime)),r.push(e.identifyTask.execute(t)),n.push(e)}})),h.publish("identify/execute",{event:i,identifies:r,identifiedlayers:n}),0<r.length&&(this.showPopup&&(this.map.infoWindow.setTitle(this.i18n.mapInfoWindow.identifyingTitle),this.map.infoWindow.setContent('<div class="loading"></div>'),this.map.infoWindow.show(e)),o(r).then(f.hitch(this,"identifyCallback",n),f.hitch(this,"identifyError"))))},checkForGraphicInfoTemplate:function(e){if(e.graphic){var i=e.graphic._layer;if(i.infoTemplate||i.capabilities&&d.indexOf(i.capabilities.toLowerCase(),"data")<0)return!1;if(!this.ignoreOtherGraphics){if(!this.identifies.hasOwnProperty(i.id))return!1;if(isNaN(i.layerId)||!this.identifies[i.id].hasOwnProperty(i.layerId))return!1}}return!0},createIdentifyParams:function(e){var i=new p;return i.tolerance=this.identifyTolerance,i.returnGeometry=!0,i.layerOption=p.LAYER_OPTION_VISIBLE,i.geometry=e,i.mapExtent=this.map.extent,i.width=this.map.width,i.height=this.map.height,i.spatialReference=this.map.spatialReference,i},getSelectedLayer:function(){var e=this.allLayersId;if(this.parentWidget){var i=this.identifyFormDijit.get("value");i.identifyLayer&&""!==i.identifyLayer?e=i.identifyLayer:this.identifyLayerDijit.set("value",e)}return e},getLayerIds:function(e,i){var t=i.split(this.layerSeparator),a=this.allLayersId,r=e.ref,n=e.layerInfo.layerIds,s=[];return r.visible&&(t[0]!==a&&r.id!==t[0]||(1<t.length&&t[1]?s=[t[1]]:"esri.layers.FeatureLayer"!==r.declaredClass||isNaN(r.layerId)?r.layerInfos&&(s=this.getLayerInfos(e,n)):r.capabilities&&0<=d.indexOf(r.capabilities.toLowerCase(),"data")&&(s=[r.layerId]))),s},getLayerInfos:function(i,t){var a=[],e=i.ref;return d.forEach(e.layerInfos,f.hitch(this,function(e){this.includeSubLayer(e,i,t)&&a.push(e.id)})),a},identifyCallback:function(t,e){var n=[];d.forEach(e,function(e,i){var r=t[i].ref;d.forEach(e,function(e){e.feature.geometry.spatialReference=this.map.spatialReference;var i=e.feature;if(void 0===i.infoTemplate){var t=this.getInfoTemplate(r,null,e);if(!t)return;e.layerId&&r.layerInfos&&t.info.showAttachments&&(e.feature._layer=this.getFeatureLayerForDynamicSublayer(r,e.layerId));var a=this.buildExpressionInfos(f.clone(t),i);i.setInfoTemplate(a)}i&&i.infoTemplate&&i.infoTemplate.info&&(i=this.getFormattedFeature(i)),n.push(i)},this)},this),this.map.infoWindow.setFeatures(n),h.publish("identify/results",{features:n,responseArray:e,identifiedlayers:t})},getFormattedFeature:function(i){var e=i.infoTemplate;return i.graphic&&(i=i.graphic),d.forEach(e.info.fieldInfos,function(e){"function"==typeof e.formatter&&(i.attributes[e.fieldName]=e.formatter(i.attributes[e.fieldName],i.attributes,f.clone(i.geometry)))}),i},buildExpressionInfos:function(e,a){if(a.graphic&&(a=a.graphic),a&&e&&e.info&&"function"==typeof e.getExpressionInfo){var i=e.info,r=i.expressionInfos||[];d.forEach(i.fieldInfos,function(e){if("function"==typeof e.formatter&&!1!==e.useExpression){var i=e.fieldName.toLowerCase()+"-formatted",t="return '"+e.formatter(a.attributes[e.fieldName],a.attributes,f.clone(a.geometry))+"'";e.fieldName="expression/"+i,(r=d.filter(r,function(e){return e.name!==i})).push({name:i,title:e.label||" ",expression:t}),e.formatter=null}}),i.expressionInfos=r,e=new m(i)}return e},identifyError:function(e){this.map.infoWindow.hide(),h.publish("viewer/handleError",{source:"Identify",error:e}),h.publish("identify/error",{error:e})},handleRightClick:function(){this.executeIdentifyTask(this.mapRightClick)},getInfoTemplate:function(e,i,t){var a,r=null;t?i="number"==typeof t.layerId?t.layerId:e.layerId:null===i&&(i=e.layerId);var n=this.identifies;if(n.hasOwnProperty(e.id)){if(n[e.id].hasOwnProperty(i)&&(r=n[e.id][i])instanceof m)return r}else n[e.id]={};return a=f.mixin(this.createDefaultInfoTemplate(e,i,t),n[e.id][i]||{}),r=n[e.id][i]=new m(a),a.content&&r.setContent(a.content),n[e.id][i]},createDefaultInfoTemplate:function(e,i,t){var a=null,r=[],n=this.getLayerName(e);if(t&&(n=t.layerName),t&&t.feature){var s=t.feature.attributes;if(s)for(var l in s)s.hasOwnProperty(l)&&this.addDefaultFieldInfo(r,{fieldName:l,label:this.makeSentenceCase(l),visible:!0})}else if(e._outFields&&e._outFields.length&&"*"!==e._outFields[0]){var o=e.fields;d.forEach(e._outFields,f.hitch(this,function(i){var e=d.filter(o,function(e){return e.name===i});0<e.length&&this.addDefaultFieldInfo(r,{fieldName:e[0].name,label:e[0].alias,visible:!0})}))}else e.fields&&d.forEach(e.fields,f.hitch(this,function(e){this.addDefaultFieldInfo(r,{fieldName:e.name,label:e.alias===e.name?this.makeSentenceCase(e.name):e.alias,visible:!0})}));return 0<r.length&&(a={title:n,fieldInfos:r,showAttachments:e.hasAttachments}),a},makeSentenceCase:function(e){if(!e.length)return"";e=e.toLowerCase().replace(/_/g," ").split(" ");for(var i=0;i<e.length;i++)e[i]=e[i].charAt(0).toUpperCase()+(e[i].substr(1).length?e[i].substr(1):"");return e.length?e.join(" "):e},addDefaultFieldInfo:function(e,i){var t=i.fieldName.toLowerCase();d.indexOf(this.excludedFields,t)<0&&e.push(i)},createIdentifyLayerList:function(){var n=null,s=[],l=this.identifyLayerDijit.get("value"),o=this.layerSeparator;d.forEach(this.layers,f.hitch(this,function(i){var t=i.ref,a=i.layerInfo.layerIds;if(t.visible){var r=this.getLayerName(i);"esri.layers.FeatureLayer"!==t.declaredClass||isNaN(t.layerId)?d.forEach(t.layerInfos,f.hitch(this,function(e){this.includeSubLayer(e,i,a)&&(s.push({name:r+" \\ "+e.name,id:t.id+o+e.id}),t.id+o+e.id===l&&(n=l))})):(s.push({name:r,id:t.id+o+t.layerId}),t.id+o+t.layerId===l&&(n=l))}})),s.sort(function(e,i){return e.name>i.name?1:i.name>e.name?-1:0}),this.identifyLayerDijit.set("disabled",s.length<1),0<s.length&&(s.unshift({name:this.i18n.labels.allVisibleLayers,id:"***"}),n||(n=s[0].id));var e=new c({data:s});this.identifyLayerDijit.set("store",e),this.identifyLayerDijit.set("value",n)},includeSubLayer:function(e,i,t){if(null!==e.subLayerIds)return!1;var a=i.ref;if(this.isDefaultLayerVisibility(a)&&!this.checkVisibilityRecursive(i,e.id))return!1;if(d.indexOf(a.visibleLayers,e.id)<0)return!1;if(!this.layerVisibleAtCurrentScale(e))return!1;if(t&&d.indexOf(t,e.id)<0)return!1;if(!this.createDefaultInfoTemplates&&!this.getInfoTemplate(a,e.id))return!1;return!0},checkVisibilityRecursive:function(e,i){var t=e.ref,a=d.filter(t.layerInfos,function(e){return e.id===i});if(0<a.length){var r=a[0];if(-1!==t.visibleLayers.indexOf(i)&&(e.layerInfo.ignoreDynamicGroupVisibility||-1===r.parentLayerId||this.checkVisibilityRecursive(e,r.parentLayerId)))return!0}return!1},isDefaultLayerVisibility:function(e){for(var i=0;i<e.layerInfos.length;i++){var t=e.layerInfos[i];if(t.defaultVisibility&&-1===e.visibleLayers.indexOf(t.id))return!1}return!0},getLayerName:function(i){var t=null;return i.layerInfo&&(t=i.layerInfo.title),t||d.forEach(this.layers,function(e){e.ref.id!==i.id||(t=e.layerInfo.title)}),t||!(t=i.name)&&i.ref&&(t=i.ref._titleForLegend),t},getFeatureLayerForDynamicSublayer:function(e,i){if(!e.layerInfos)return!1;var t=e.url+"/"+i;return this.featureLayers.hasOwnProperty(t)||(this.featureLayers[t]=new I(t)),this.featureLayers[t]},layerVisibleAtCurrentScale:function(e){var i=this.map.getScale();return!(0!==e.maxScale&&i<e.maxScale||0!==e.minScale&&i>e.minScale)},setMapClickMode:function(t){this.mapClickMode=t;var a=this.map;d.forEach(a.graphicsLayerIds,function(e){var i=a.getLayer(e);i&&("identify"===t?this.infoTemplates[i.id]&&(i.infoTemplate=f.clone(this.infoTemplates[i.id])):i.infoTemplate&&(this.infoTemplates[i.id]=f.clone(i.infoTemplate),i.infoTemplate=null))},this)}})});
//# sourceMappingURL=Identify.js.map