/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/topic","dojo/dom-attr","dojo/dom-construct","dijit/_WidgetBase","dijit/_Container","dijit/layout/ContentPane","dijit/form/Button","esri/tasks/ProjectParameters","esri/config","require","xstyle/css!./LayerControl/css/LayerControl.css"],function(r,n,a,s,t,i,o,l,d,c,h,y,f){return r([o,l],{map:null,layerInfos:[],icons:{expand:"fas fa-caret-right fa-fw layerControlIcon-Expand",collapse:"fas fa-caret-down fa-fw layerControlIcon-Collapse",checked:"fas fa-check fa-fw fa-border layerControlIcon-Checked",unchecked:"fas fa-square fa-fw fa-border layerControlIcon-Unchecked",indeterminate:"fas fa-minus fa-fw fa-border layerControlIcon-Indeterminate",update:"fas fa-spin fa-sync layerControlIcon-Update",menu:"fas fa-bars layerControlIcon-Menu",folder:"fas fa-folder fa-fw layerControlIcon-Folder",folderOpen:"fas fa-folder-open fa-fw layerControlIcon-Folder layerControlIcon-FolderOpen"},separated:!1,overlayReorder:!1,overlayLabel:!1,vectorReorder:!1,vectorLabel:!1,noMenu:null,noLegend:null,noZoom:null,noTransparency:null,menu:{},subLayerMenu:{},swipe:null,swiperButtonStyle:"position:absolute;top:20px;left:120px;z-index:50;",baseClass:"layerControlDijit",_vectorContainer:null,_overlayContainer:null,_swiper:null,_swipeLayerToggleHandle:null,_groupedLayerInfos:{},_controls:{dynamic:"./LayerControl/controls/Dynamic",feature:"./LayerControl/controls/Feature",image:"./LayerControl/controls/Image",tiled:"./LayerControl/controls/Tiled",csv:"./LayerControl/controls/CSV",georss:"./LayerControl/controls/GeoRSS",wms:"./LayerControl/controls/WMS",wfs:"./LayerControl/controls/WFS",kml:"./LayerControl/controls/KML",vectortile:"./LayerControl/controls/VectorTile",webtiled:"./LayerControl/controls/WebTiled",imagevector:"./LayerControl/controls/ImageVector",raster:"./LayerControl/controls/Raster",stream:"./LayerControl/controls/Stream",grouped:"./LayerControl/controls/Grouped",graphics:"./LayerControl/controls/Graphics",osm:"./LayerControl/controls/OpenStreetMap"},constructor:function(e){(e=e||{}).map?this._controls=a.mixin(this._controls,e.controls||{}):s.publish("viewer/handleError",{source:"LayerControl",error:"map option is required"})},postCreate:function(){if(this.inherited(arguments),this.separated){var e=r([o,l]);!1!==this.vectorLabel&&this.addChild(new d({className:"vectorLabelContainer",content:this.vectorLabel},i.create("div")),"first"),this._vectorContainer=new e({className:"vectorLayerContainer"},i.create("div")),this.addChild(this._vectorContainer,"last"),!1!==this.overlayLabel&&this.addChild(new d({className:"overlayLabelContainer",content:this.overlayLabel},i.create("div")),"last"),this._overlayContainer=new e({className:"overlayLayerContainer"},i.create("div")),this.addChild(this._overlayContainer,"last")}else this.overlayReorder=!1,this.vectorReorder=!1;this._addLayerControls(this.layerInfos),this._subscribeToTopics()},_subscribeToTopics:function(){this._removeLayerControlsHandler=s.subscribe("layerControl/removeLayerControls",a.hitch(this,function(e){this._removeLayerControls(e)})),this._addLayerControlsHandler=s.subscribe("layerControl/addLayerControls",a.hitch(this,function(e){this._addLayerControls(e)}))},_addLayerControls:function(i){var t=[];n.forEach(i,function(e){e.controlOptions=e.controlOptions||{};var r=e.controlOptions;if(!0!==r.exclude){r.layerGroup&&(this.overlayReorder=!1,this.vectorReorder=!1);var o=this._controls[e.type];o?t.push(o):s.publish("viewer/handleError",{source:"LayerControl",error:'the layer type "'+e.type+'" is not supported'})}},this),f(t,a.hitch(this,function(){for(var e in n.forEach(i,function(e){if(!0!==e.controlOptions.exclude){var r=this._controls[e.type];r&&f([r],a.hitch(this,"_addControl",e))}},this),this._groupedLayerInfos)if(this._groupedLayerInfos.hasOwnProperty(e)){var r=this._groupedLayerInfos[e];if(r&&1<r.length){var o=this._controls.grouped,t={title:e,type:"grouped",controlOptions:{},layer:{id:e.replace(/\s/g,""),loaded:!0,getMap:a.hitch(this,function(){return this.map}),minScale:0,maxScale:0,_params:{}},layerDetails:r};f([o],a.hitch(this,"_addControl",t))}}this._groupedLayerInfos={},this._checkReorder()}))},_removeLayerControls:function(e){function r(o){return e.reduce(function(e,r){return r===o.layer||e},!1)}var o=this._overlayContainer.getChildren().filter(function(e){return r(e)}).concat(this._vectorContainer.getChildren().filter(function(e){return r(e)})).concat(this.getChildren().filter(function(e){return r(e)}));n.forEach(o,a.hitch(this,function(e){this.separated?"overlay"===e._layerType?this._overlayContainer.removeChild(e):this._vectorContainer.removeChild(e):this.removeChild(e),e.destroy()}))},_addControl:function(e,r){var o="string"==typeof e.layer?this.map.getLayer(e.layer):e.layer;"dynamic"!==e.type&&"feature"!==e.type||(o.loaded?this._applyLayerControlOptions(e.controlOptions,o):o.on("load",a.hitch(this,"_applyLayerControlOptions",e.controlOptions)));var t=new r({controller:this,layer:o,layerTitle:e.title,layerDetails:e.layerDetails,controlOptions:a.mixin({noLegend:null,noZoom:null,noTransparency:null,swipe:null,expanded:!1,sublayers:!0,layerGroup:null,menu:this.menu[e.type],subLayerMenu:this.subLayerMenu[e.type]},e.controlOptions)});t.startup();var i=e.position||0,n=t._layerType;"grouped"===n&&t.layerDetails&&0<t.layerDetails.length&&(t._layerType=t.layerDetails[0].layerControl._layerType),this.separated?"overlay"===n?this._overlayContainer.addChild(t,i):this._vectorContainer.addChild(t,i):this.addChild(t,i),this._storeGroupedLayerInfo(e,t)},_storeGroupedLayerInfo:function(e,r){if(e.controlOptions.layerGroup){var o=e.controlOptions.layerGroup;this._groupedLayerInfos.hasOwnProperty(o)||(this._groupedLayerInfos[o]=[]),this._groupedLayerInfos[o].push({layerInfo:e,layerControl:r})}},_applyLayerControlOptions:function(r,e){if(void 0!==r.includeUnspecifiedLayers||void 0!==r.subLayerInfos||void 0!==r.excludedLayers){var o=[];if(!r.includeUnspecifiedLayers&&r.subLayerInfos&&0!==r.subLayerInfos.length){var t=n.map(r.subLayerInfos,function(e){return e.id});n.forEach(e.layerInfos,function(e){-1!==n.indexOf(t,e.id)&&o.push(e)})}else if(r.excludedLayers)n.forEach(e.layerInfos,function(e){-1===n.indexOf(r.excludedLayers,e.id)&&o.push(e)});else if(r.subLayerInfos)return this._mixinLayerInfos(e.layerInfos,r.subLayerInfos),void this._setSublayerVisibilities(e);r.subLayerInfos&&this._mixinLayerInfos(o,r.subLayerInfos),e.layerInfos=o,this._setSublayerVisibilities(e)}},_setSublayerVisibilities:function(e){var r=n.map(n.filter(e.layerInfos,function(e){return e.defaultVisibility}),function(e){return e.id});e.setVisibleLayers(r)},_mixinLayerInfos:function(e,o){o&&0!==o.length&&(n.forEach(o,function(e){void 0===e.defaultVisibility&&(e.defaultVisibility=!0)}),n.forEach(e,function(r){var e=n.filter(o,function(e){return e.id===r.id}).shift();e&&a.mixin(r,e)}))},_moveUp:function(e){var r,o=e.layer.id,t=e.domNode;"overlay"===e._layerType?e.getPreviousSibling()&&(r=n.indexOf(this.map.layerIds,o),this.map.reorderLayer(o,r+1),this._overlayContainer.containerNode.insertBefore(t,t.previousSibling),this._checkReorder()):"vector"===e._layerType&&e.getPreviousSibling()&&(r=n.indexOf(this.map.graphicsLayerIds,o),this.map.reorderLayer(o,r+1),this._vectorContainer.containerNode.insertBefore(t,t.previousSibling),this._checkReorder())},_moveDown:function(e){var r,o=e.layer.id,t=e.domNode;"overlay"===e._layerType?e.getNextSibling()&&(r=n.indexOf(this.map.layerIds,o),this.map.reorderLayer(o,r-1),this._overlayContainer.containerNode.insertBefore(t,t.nextSibling.nextSibling),this._checkReorder()):"vector"===e._layerType&&e.getNextSibling()&&(r=n.indexOf(this.map.graphicsLayerIds,o),this.map.reorderLayer(o,r-1),this._vectorContainer.containerNode.insertBefore(t,t.nextSibling.nextSibling),this._checkReorder())},_checkReorder:function(){this.separated&&(this.vectorReorder&&n.forEach(this._vectorContainer.getChildren(),function(e){e._reorderUp&&(e.getPreviousSibling()?e._reorderUp.set("disabled",!1):e._reorderUp.set("disabled",!0)),e._reorderDown&&(e.getNextSibling()?e._reorderDown.set("disabled",!1):e._reorderDown.set("disabled",!0))},this),this.overlayReorder&&n.forEach(this._overlayContainer.getChildren(),function(e){e._reorderUp&&(e.getPreviousSibling()?e._reorderUp.set("disabled",!1):e._reorderUp.set("disabled",!0)),e._reorderDown&&(e.getNextSibling()?e._reorderDown.set("disabled",!1):e._reorderDown.set("disabled",!0))},this))},_zoomToLayer:function(e){if("esri.layers.KMLLayer"!==e.declaredClass){var r=this.map;e.spatialReference===r.spatialReference?r.setExtent(e.fullExtent,!0):y.defaults.geometryService?y.defaults.geometryService.project(a.mixin(new h,{geometries:[e.fullExtent],outSR:r.spatialReference}),function(e){r.setExtent(e[0],!0)},function(e){s.publish("viewer/handleError",{source:"LayerControl._zoomToLayer",error:e})}):s.publish("viewer/handleError",{source:"LayerControl._zoomToLayer",error:"esriConfig.defaults.geometryService is not set"})}},_swipeLayer:function(r,o){r&&r.visible&&(this._swiper?(this._swiper.disable(),this._swipeLayerToggleHandle&&this._swipeLayerToggleHandle.remove(),this._swiper.set("layers",[r]),this._swiper.set("type",o),this._swiper.enable(),t.set(this._swiper.disableBtn.domNode,"style",this.swiperButtonStyle)):f(["esri/dijit/LayerSwipe"],a.hitch(this,function(e){this._swiper=new e({type:o||"vertical",map:this.map,layers:[r]},i.create("div",{},this.map.id,"first")),this._swiper.startup(),this._swiper.disableBtn=new c({label:"Exit Layer Swipe",onClick:a.hitch(this,"_swipeDisable")},i.create("div",{},this.map.id)),t.set(this._swiper.disableBtn.domNode,"style",this.swiperButtonStyle)})),this._swipeLayerToggleHandle=s.subscribe("layerControl/layerToggle",a.hitch(this,function(e){e.id!==r.id||e.visible||this._swipeDisable()})))},_swipeDisable:function(){this._swiper.disable(),this._swipeLayerToggleHandle&&this._swipeLayerToggleHandle.remove(),t.set(this._swiper.disableBtn.domNode,"style","display:none;")},showAllLayers:function(){this.separated?(n.forEach(this._vectorContainer.getChildren(),function(e){e.layer.show()}),n.forEach(this._overlayContainer.getChildren(),function(e){e.layer.show()})):n.forEach(this.getChildren(),function(e){e.layer.show()})},hideAllLayers:function(){this.separated?(n.forEach(this._vectorContainer.getChildren(),function(e){e.layer.hide()}),n.forEach(this._overlayContainer.getChildren(),function(e){e.layer.hide()})):n.forEach(this.getChildren(),function(e){e.layer.hide()})}})});
//# sourceMappingURL=LayerControl.js.map