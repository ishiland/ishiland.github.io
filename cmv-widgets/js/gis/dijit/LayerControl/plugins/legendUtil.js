/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/array","dojo/_base/lang","dojo/has","dojo/topic","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/html","dijit/registry","dojox/gfx","esri/request","esri/dijit/Legend","dojo/i18n!esri/nls/jsapi","dojo/i18n!./../nls/resource"],function(o,s,l,m,L,p,b,_,c,v,d,t,e,r){return e.widgets.legend.NLS_noLegend=r.noLegend,{isLegend:function(e,r){return null===r||!1===r?!0!==e:!0===r&&!1===e},_legendRequest:function(e,r,a,t){var n={f:"json",token:"function"==typeof e._getToken?e._getToken():null},i={disableIdentityLookup:!1,usePost:!1,useProxy:!1};e.layerDrawingOptions&&0<e.layerDrawingOptions.length&&(n.dynamicLayers=this._createDynamicLayerParameter(e),i.usePost=!0),d({url:e.url+"/legend",callbackParamName:"callback",content:n},i).then(s.hitch(this,a,e,r),s.hitch(this,t,e,r))},_arcgisLegendRequest:function(e,r,a,t){var n=e.url.toLowerCase().indexOf("/rest/"),i=e.url.substring(0,n)+e.url.substring(n+5,e.url.length),o="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+window.escape(i);(!l("ie")||8<l("ie"))&&(o+="&returnbytes=true"),d({url:o,callbackParamName:"callback",content:{f:"json"}}).then(s.hitch(this,a,e,r),s.hitch(this,t,e,r))},_image:function(e,r,a){var t=e.url;if((!l("ie")||9<=l("ie"))&&e.imageData&&0<e.imageData.length)t="data:image/png;base64,"+e.imageData;else if(0!==e.url.indexOf("http")){t=a.url+"/"+r+"/images/"+e.url;var n=a._getToken();n&&(t+="?token="+n)}var i=L.create("img",{src:t,class:a.id+"-layerLegendImage"});return b.set(i,{width:e.width+"px",height:e.height+"px",opacity:a.opacity}),i},layerLegend:function(e,r){var a=new t({map:e.getMap(),layerInfos:[{layer:e}]},L.create("div",{},r));setTimeout(function(){a.startup()},1)},dynamicSublayerLegend:function(e,r){10.01<=e.version?this._legendRequest(e,r,"_createDynamicSublayerLegend","_dynamicSublayerLegendError"):this._arcgisLegendRequest(e,r,"_createDynamicSublayerLegend","_dynamicSublayerLegendError")},_createDynamicSublayerLegend:function(i,r,e){o.forEach(e.layers,function(a){var t=a.layerId,n=L.create("table");if(p.add(n,"layerControlLegendTable"),o.forEach(a.legend,function(e){var r=L.create("tr",{},n,"last"),a=L.create("td",{class:"layerControlLegendImage"},r,"first");L.create("td",{innerHTML:e.label||"&nbsp;",class:"layerControlLegendLabel"},r,"last"),L.place(this._image(e,t,i),a)},this),i.layerInfos.reduce(function(e,r){return r.id===a.layerId||e},!1))if(1<i.layerInfos.length){var e=c.byId(i.id+"-"+a.layerId+"-sublayer-control").expandNode;_.set(e,""),L.place(n,e)}else L.place(n,r)},this)},_dynamicSublayerLegendError:function(e,r,a){1===e.layerInfos.length&&_.set(r,"No Legend"),m.publish("viewer/handleError",{source:"LayerControl/legendUtil/_createDynamicSublayerLegend",error:a})},_surfaceDims:[20,20],vectorLegend:function(e,r){var a=e.renderer.symbol,t=e.renderer.infos;a?this._createVectorLegend([{symbol:a,description:"",label:"",value:""}],e,r):t?this._createVectorLegend(t,e,r):_.set(r,"No Legend")},_createVectorLegend:function(e,u,h){var f=L.create("table");p.add(f,"layerControlLegendTable"),o.forEach(e,function(e){var r=L.create("tr",{},f,"last"),a=L.create("td",{class:"layerControlLegendImage"},r,"first");L.create("td",{innerHTML:e.label||"&nbsp;",class:"layerControlLegendLabel"},r,"last");var t=e.symbol,n=t.getShapeDescriptors(),i=n.defaultShape,o=n.fill,s=n.stroke;if(i.src){var l=L.create("img",{src:i.src},a);b.set(l,{width:t.width+"px",height:t.height+"px",opacity:u.opacity}),p.add(l,u.id+"-layerLegendImage")}else if(t){var c=this._surfaceDims[0],d=this._surfaceDims[1];t.width&&t.height&&(c=t.width,d=t.height);var g=L.create("span",{},a);b.set(g,{width:c+"px",height:d+"px",display:"inline-block"});var y=v.createSurface(g,c,d).createShape(i);o&&y.setFill(o),s&&y.setStroke(s),y.applyTransform({dx:c/2,dy:d/2}),b.set(a,{opacity:u.opacity}),p.add(a,u.id+"-layerLegendImage")}else _.set(h,"No Legend"),m.publish("viewer/handleError",{source:"LayerControl/legendUtil/_createVectorLegend",error:"renderer does not contain symbol(s)"});L.place(f,h)},this)},_createDynamicLayerParameter:function(t){if(t.dynamicLayerInfos&&0<t.dynamicLayerInfos.length||t.layerDrawingOptions&&0<t.layerDrawingOptions.length){t.dynamicLayerInfos=t.createDynamicLayerInfosFromLayerInfos();var e=t.dynamicLayerInfos,n=[];return e.forEach(function(e){if(!e.subLayerIds){var r,a=e.id;r={id:a,name:e.name},e.source&&(r.source=e.source.toJson()),t.layerDrawingOptions&&t.layerDrawingOptions[a]&&(r.drawingInfo=t.layerDrawingOptions[a].toJson()),n.push(r)}},this),JSON.stringify(n)}return null}}});
//# sourceMappingURL=legendUtil.js.map