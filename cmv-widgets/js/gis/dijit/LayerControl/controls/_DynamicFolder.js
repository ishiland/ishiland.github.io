/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.2
 *  Project: https://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/on","dojo/query","dojo/dom-class","dojo/dom-style","dojo/dom-attr","dojo/fx","dojo/html","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/Folder.html"],function(e,a,s,n,t,c,i,l,r,o,d,h,u){return e([d,h],{control:null,sublayerInfo:null,icons:null,templateString:u,_expandClickHandler:null,_handlers:[],postCreate:function(){this.inherited(arguments),this._checkHideControl();var t=this.checkNode;l.set(t,"data-sublayer-id",this.sublayerInfo.id),l.set(t,"data-layer-folder",!0),c.add(t,this.control.layer.id+"-layerControlSublayerCheck"),this._handlers.push(n(t,"click",a.hitch(this,function(e){e.stopPropagation&&e.stopPropagation(),this.control.controlOptions.ignoreDynamicGroupVisibility?this._hasAnyInvisibleLayer()?this._setFolderCheckbox(!0,t):this._setFolderCheckbox(!1,t):this._setFolderCheckbox(!this._isVisible(),t),this._checkboxScaleRange()}))),o.set(this.labelNode,this.sublayerInfo.name),this._expandClick(),0===this.sublayerInfo.minScale&&0===this.sublayerInfo.maxScale||(this._checkboxScaleRange(),this._handlers.push(this.control.layer.getMap().on("zoom-end",a.hitch(this,"_checkboxScaleRange"))))},_expandClick:function(){var o=this.icons;this._handlers.push(this._expandClickHandler=n(this.expandClickNode,"click",a.hitch(this,function(){var e=this.expandNode,t=this.expandIconNode;"none"===i.get(e,"display")?(r.wipeIn({node:e,duration:300}).play(),c.replace(t,o.folderOpen,o.folder)):(r.wipeOut({node:e,duration:300}).play(),c.replace(t,o.folder,o.folderOpen))})))},_setFolderCheckbox:function(o,e,t){var n=this.icons,i=o?"checked":"unchecked",r=this._getSubLayerNodes();e=e||this.checkNode,this.control.controlOptions.ignoreDynamicGroupVisibility?s.forEach(r,a.hitch(this,function(e){if(l.get(e,"data-layer-folder")){var t=this._getFolderControl(e);t&&t._setFolderCheckbox(o,e,!0)}else l.set(e,"data-checked",i),o?c.replace(e,n.checked,n.unchecked):c.replace(e,n.unchecked,n.checked)})):(l.set(e,"data-checked",i),o?c.replace(e,n.checked,n.unchecked):c.replace(e,n.unchecked,n.checked)),t||this.control._setVisibleLayers()},_hasAnyVisibleLayer:function(){var e=this._getSubLayerNodes();return s.some(e,a.hitch(this,function(e){if(l.get(e,"data-layer-folder")){var t=this._getFolderControl(e);return!t||t._hasAnyVisibleLayer()}return"checked"===l.get(e,"data-checked")}))},_hasAnyInvisibleLayer:function(){var e=this._getSubLayerNodes();return s.some(e,a.hitch(this,function(e){if(l.get(e,"data-layer-folder")){var t=this._getFolderControl(e);return!t||t._hasAnyInvisibleLayer()}return"checked"!==l.get(e,"data-checked")}))},_getSubLayerNodes:function(){var o=this.control.controlOptions.layerIds||[],n=[];this.control.controlOptions.subLayerInfos&&!this.control.controlOptions.includeUnspecifiedLayers&&(n=s.map(this.control.controlOptions.subLayerInfos,function(e){return e.id}));var e=t("."+this.control.layer.id+"-layerControlSublayerCheck",this.domNode);return s.filter(e,a.hitch(this,function(e){var t=parseInt(l.get(e,"data-sublayer-id"),10);return!(s.indexOf(this.sublayerInfo.subLayerIds,t)<0)&&(!(o.length&&s.indexOf(o,t)<0)&&!(n.length&&s.indexOf(n,t)<0))}))},_getSubLayerControls:function(){var t=this.sublayerInfo.id;return s.filter(this.control._sublayerControls,function(e){return e.parentLayerId===t})},_getFolderControls:function(){var t=this.sublayerInfo.id;return s.filter(this.control._folderControls,function(e){return e.parentLayerId===t})},_getFolderControl:function(e){var t=parseInt(l.get(e,"data-sublayer-id"),10),o=s.filter(this.control._folderControls,function(e){return e.sublayerInfo.id===t});return o.length?o[0]:null},_checkFolderVisibility:function(){var e=this.checkNode,t=this.icons,o=this._hasAnyVisibleLayer(),n=this._hasAnyInvisibleLayer();c.remove(e,t.checked),c.remove(e,t.unchecked),c.remove(e,t.indeterminate),o&&n?(l.set(e,"data-checked","indeterminate"),c.add(e,t.indeterminate)):o?(l.set(e,"data-checked","checked"),c.add(e,t.checked)):(l.set(e,"data-checked","unchecked"),c.add(e,t.unchecked))},_checkboxScaleRange:function(){var e=this.checkNode,t=this.control.layer.getMap().getScale(),o=this.sublayerInfo.minScale,n=this.sublayerInfo.maxScale;c.remove(e,"layerControlCheckIconOutScale"),(0!==o&&o<t||0!==n&&t<n)&&c.add(e,"layerControlCheckIconOutScale")},_checkHideControl:function(){if(this.control.controlOptions.subLayerInfos&&!this.control.controlOptions.includeUnspecifiedLayers){var e=s.map(this.control.controlOptions.subLayerInfos,function(e){return e.id});s.indexOf(e,this.sublayerInfo.id)<0&&c.add(this.domNode,"layerControlHidden")}this.control.controlOptions.layerIds&&s.indexOf(this.control.controlOptions.layerIds,this.sublayerInfo.id)<0&&c.add(this.domNode,"layerControlHidden")},_isVisible:function(){return"checked"===l.get(this.checkNode,"data-checked")},destroy:function(){this.inherited(arguments),this._handlers.forEach(function(e){e.remove()})}})});
//# sourceMappingURL=_DynamicFolder.js.map